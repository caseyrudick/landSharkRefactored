{"ast":null,"code":"/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar d3 = require('d3');\n\nvar Lib = require('../../lib');\n\nvar strTranslate = Lib.strTranslate;\n\nvar xmlnsNamespaces = require('../../constants/xmlns_namespaces');\n\nvar constants = require('./constants');\n\nvar unsupportedBrowsers = Lib.isIOS() || Lib.isSafari() || Lib.isIE();\n\nmodule.exports = function plot(gd, plotinfo, cdimage, imageLayer) {\n  var xa = plotinfo.xaxis;\n  var ya = plotinfo.yaxis;\n  var supportsPixelatedImage = !(unsupportedBrowsers || gd._context._exportedPlot);\n  Lib.makeTraceGroups(imageLayer, cdimage, 'im').each(function (cd) {\n    var plotGroup = d3.select(this);\n    var cd0 = cd[0];\n    var trace = cd0.trace;\n    var fastImage = supportsPixelatedImage && !trace._hasZ && trace._hasSource && xa.type === 'linear' && ya.type === 'linear';\n    trace._fastImage = fastImage;\n    var z = cd0.z;\n    var x0 = cd0.x0;\n    var y0 = cd0.y0;\n    var w = cd0.w;\n    var h = cd0.h;\n    var dx = trace.dx;\n    var dy = trace.dy;\n    var left, right, temp, top, bottom, i; // in case of log of a negative\n\n    i = 0;\n\n    while (left === undefined && i < w) {\n      left = xa.c2p(x0 + i * dx);\n      i++;\n    }\n\n    i = w;\n\n    while (right === undefined && i > 0) {\n      right = xa.c2p(x0 + i * dx);\n      i--;\n    }\n\n    i = 0;\n\n    while (top === undefined && i < h) {\n      top = ya.c2p(y0 + i * dy);\n      i++;\n    }\n\n    i = h;\n\n    while (bottom === undefined && i > 0) {\n      bottom = ya.c2p(y0 + i * dy);\n      i--;\n    }\n\n    if (right < left) {\n      temp = right;\n      right = left;\n      left = temp;\n    }\n\n    if (bottom < top) {\n      temp = top;\n      top = bottom;\n      bottom = temp;\n    } // Reduce image size when zoomed in to save memory\n\n\n    if (!fastImage) {\n      var extra = 0.5; // half the axis size\n\n      left = Math.max(-extra * xa._length, left);\n      right = Math.min((1 + extra) * xa._length, right);\n      top = Math.max(-extra * ya._length, top);\n      bottom = Math.min((1 + extra) * ya._length, bottom);\n    }\n\n    var imageWidth = Math.round(right - left);\n    var imageHeight = Math.round(bottom - top); // if image is entirely off-screen, don't even draw it\n\n    var isOffScreen = imageWidth <= 0 || imageHeight <= 0;\n\n    if (isOffScreen) {\n      var noImage = plotGroup.selectAll('image').data([]);\n      noImage.exit().remove();\n      return;\n    } // Create a new canvas and draw magnified pixels on it\n\n\n    function drawMagnifiedPixelsOnCanvas(readPixel) {\n      var canvas = document.createElement('canvas');\n      canvas.width = imageWidth;\n      canvas.height = imageHeight;\n      var context = canvas.getContext('2d');\n\n      var ipx = function (i) {\n        return Lib.constrain(Math.round(xa.c2p(x0 + i * dx) - left), 0, imageWidth);\n      };\n\n      var jpx = function (j) {\n        return Lib.constrain(Math.round(ya.c2p(y0 + j * dy) - top), 0, imageHeight);\n      };\n\n      var cr = constants.colormodel[trace.colormodel];\n      var colormodel = cr.colormodel || trace.colormodel;\n      var fmt = cr.fmt;\n      var c;\n\n      for (i = 0; i < cd0.w; i++) {\n        var ipx0 = ipx(i);\n        var ipx1 = ipx(i + 1);\n        if (ipx1 === ipx0 || isNaN(ipx1) || isNaN(ipx0)) continue;\n\n        for (var j = 0; j < cd0.h; j++) {\n          var jpx0 = jpx(j);\n          var jpx1 = jpx(j + 1);\n          if (jpx1 === jpx0 || isNaN(jpx1) || isNaN(jpx0) || !readPixel(i, j)) continue;\n          c = trace._scaler(readPixel(i, j));\n\n          if (c) {\n            context.fillStyle = colormodel + '(' + fmt(c).join(',') + ')';\n          } else {\n            // Return a transparent pixel\n            context.fillStyle = 'rgba(0,0,0,0)';\n          }\n\n          context.fillRect(ipx0, jpx0, ipx1 - ipx0, jpx1 - jpx0);\n        }\n      }\n\n      return canvas;\n    }\n\n    var image3 = plotGroup.selectAll('image').data([cd]);\n    image3.enter().append('svg:image').attr({\n      xmlns: xmlnsNamespaces.svg,\n      preserveAspectRatio: 'none'\n    });\n    image3.exit().remove(); // Pixelated image rendering\n    // http://phrogz.net/tmp/canvas_image_zoom.html\n    // https://developer.mozilla.org/en-US/docs/Web/CSS/image-rendering\n\n    var style = 'image-rendering: optimizeSpeed; image-rendering: -moz-crisp-edges; image-rendering: -o-crisp-edges; image-rendering: -webkit-optimize-contrast; image-rendering: optimize-contrast; image-rendering: crisp-edges; image-rendering: pixelated;';\n\n    if (fastImage) {\n      var xRange = Lib.simpleMap(xa.range, xa.r2l);\n      var yRange = Lib.simpleMap(ya.range, ya.r2l);\n      var flipX = xRange[1] < xRange[0];\n      var flipY = yRange[1] > yRange[0];\n\n      if (flipX || flipY) {\n        var tx = left + imageWidth / 2;\n        var ty = top + imageHeight / 2;\n        style += 'transform:' + strTranslate(tx + 'px', ty + 'px') + 'scale(' + (flipX ? -1 : 1) + ',' + (flipY ? -1 : 1) + ')' + strTranslate(-tx + 'px', -ty + 'px') + ';';\n      }\n    }\n\n    image3.attr('style', style);\n    var p = new Promise(function (resolve) {\n      if (trace._hasZ) {\n        resolve();\n      } else if (trace._hasSource) {\n        // Check if canvas already exists and has the right data\n        if (trace._canvas && trace._canvas.el.width === w && trace._canvas.el.height === h && trace._canvas.source === trace.source) {\n          resolve();\n        } else {\n          // Create a canvas and transfer image onto it to access pixel information\n          var canvas = document.createElement('canvas');\n          canvas.width = w;\n          canvas.height = h;\n          var context = canvas.getContext('2d');\n          trace._image = trace._image || new Image();\n          var image = trace._image;\n\n          image.onload = function () {\n            context.drawImage(image, 0, 0);\n            trace._canvas = {\n              el: canvas,\n              source: trace.source\n            };\n            resolve();\n          };\n\n          image.setAttribute('src', trace.source);\n        }\n      }\n    }).then(function () {\n      var href, canvas;\n\n      if (trace._hasZ) {\n        canvas = drawMagnifiedPixelsOnCanvas(function (i, j) {\n          return z[j][i];\n        });\n        href = canvas.toDataURL('image/png');\n      } else if (trace._hasSource) {\n        if (fastImage) {\n          href = trace.source;\n        } else {\n          var context = trace._canvas.el.getContext('2d');\n\n          var data = context.getImageData(0, 0, w, h).data;\n          canvas = drawMagnifiedPixelsOnCanvas(function (i, j) {\n            var index = 4 * (j * w + i);\n            return [data[index], data[index + 1], data[index + 2], data[index + 3]];\n          });\n          href = canvas.toDataURL('image/png');\n        }\n      }\n\n      image3.attr({\n        'xlink:href': href,\n        height: imageHeight,\n        width: imageWidth,\n        x: left,\n        y: top\n      });\n    });\n\n    gd._promises.push(p);\n  });\n};","map":{"version":3,"sources":["/Users/caseyrudick/Documents/landsharkrefactored-copy/client/node_modules/plotly.js/src/traces/image/plot.js"],"names":["d3","require","Lib","strTranslate","xmlnsNamespaces","constants","unsupportedBrowsers","isIOS","isSafari","isIE","module","exports","plot","gd","plotinfo","cdimage","imageLayer","xa","xaxis","ya","yaxis","supportsPixelatedImage","_context","_exportedPlot","makeTraceGroups","each","cd","plotGroup","select","cd0","trace","fastImage","_hasZ","_hasSource","type","_fastImage","z","x0","y0","w","h","dx","dy","left","right","temp","top","bottom","i","undefined","c2p","extra","Math","max","_length","min","imageWidth","round","imageHeight","isOffScreen","noImage","selectAll","data","exit","remove","drawMagnifiedPixelsOnCanvas","readPixel","canvas","document","createElement","width","height","context","getContext","ipx","constrain","jpx","j","cr","colormodel","fmt","c","ipx0","ipx1","isNaN","jpx0","jpx1","_scaler","fillStyle","join","fillRect","image3","enter","append","attr","xmlns","svg","preserveAspectRatio","style","xRange","simpleMap","range","r2l","yRange","flipX","flipY","tx","ty","p","Promise","resolve","_canvas","el","source","_image","Image","image","onload","drawImage","setAttribute","then","href","toDataURL","getImageData","index","x","y","_promises","push"],"mappings":"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","sourcesContent":["/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n\n'use strict';\n\nvar d3 = require('d3');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar xmlnsNamespaces = require('../../constants/xmlns_namespaces');\nvar constants = require('./constants');\n\nvar unsupportedBrowsers = Lib.isIOS() || Lib.isSafari() || Lib.isIE();\n\nmodule.exports = function plot(gd, plotinfo, cdimage, imageLayer) {\n    var xa = plotinfo.xaxis;\n    var ya = plotinfo.yaxis;\n\n    var supportsPixelatedImage = !(unsupportedBrowsers || gd._context._exportedPlot);\n\n    Lib.makeTraceGroups(imageLayer, cdimage, 'im').each(function(cd) {\n        var plotGroup = d3.select(this);\n        var cd0 = cd[0];\n        var trace = cd0.trace;\n        var fastImage = supportsPixelatedImage && !trace._hasZ && trace._hasSource && xa.type === 'linear' && ya.type === 'linear';\n        trace._fastImage = fastImage;\n\n        var z = cd0.z;\n        var x0 = cd0.x0;\n        var y0 = cd0.y0;\n        var w = cd0.w;\n        var h = cd0.h;\n        var dx = trace.dx;\n        var dy = trace.dy;\n\n        var left, right, temp, top, bottom, i;\n        // in case of log of a negative\n        i = 0;\n        while(left === undefined && i < w) {\n            left = xa.c2p(x0 + i * dx);\n            i++;\n        }\n        i = w;\n        while(right === undefined && i > 0) {\n            right = xa.c2p(x0 + i * dx);\n            i--;\n        }\n        i = 0;\n        while(top === undefined && i < h) {\n            top = ya.c2p(y0 + i * dy);\n            i++;\n        }\n        i = h;\n        while(bottom === undefined && i > 0) {\n            bottom = ya.c2p(y0 + i * dy);\n            i--;\n        }\n\n        if(right < left) {\n            temp = right;\n            right = left;\n            left = temp;\n        }\n\n        if(bottom < top) {\n            temp = top;\n            top = bottom;\n            bottom = temp;\n        }\n\n        // Reduce image size when zoomed in to save memory\n        if(!fastImage) {\n            var extra = 0.5; // half the axis size\n            left = Math.max(-extra * xa._length, left);\n            right = Math.min((1 + extra) * xa._length, right);\n            top = Math.max(-extra * ya._length, top);\n            bottom = Math.min((1 + extra) * ya._length, bottom);\n        }\n\n        var imageWidth = Math.round(right - left);\n        var imageHeight = Math.round(bottom - top);\n\n        // if image is entirely off-screen, don't even draw it\n        var isOffScreen = (imageWidth <= 0 || imageHeight <= 0);\n        if(isOffScreen) {\n            var noImage = plotGroup.selectAll('image').data([]);\n            noImage.exit().remove();\n            return;\n        }\n\n        // Create a new canvas and draw magnified pixels on it\n        function drawMagnifiedPixelsOnCanvas(readPixel) {\n            var canvas = document.createElement('canvas');\n            canvas.width = imageWidth;\n            canvas.height = imageHeight;\n            var context = canvas.getContext('2d');\n\n            var ipx = function(i) {return Lib.constrain(Math.round(xa.c2p(x0 + i * dx) - left), 0, imageWidth);};\n            var jpx = function(j) {return Lib.constrain(Math.round(ya.c2p(y0 + j * dy) - top), 0, imageHeight);};\n\n            var cr = constants.colormodel[trace.colormodel];\n            var colormodel = (cr.colormodel || trace.colormodel);\n            var fmt = cr.fmt;\n            var c;\n            for(i = 0; i < cd0.w; i++) {\n                var ipx0 = ipx(i); var ipx1 = ipx(i + 1);\n                if(ipx1 === ipx0 || isNaN(ipx1) || isNaN(ipx0)) continue;\n                for(var j = 0; j < cd0.h; j++) {\n                    var jpx0 = jpx(j); var jpx1 = jpx(j + 1);\n                    if(jpx1 === jpx0 || isNaN(jpx1) || isNaN(jpx0) || !readPixel(i, j)) continue;\n                    c = trace._scaler(readPixel(i, j));\n                    if(c) {\n                        context.fillStyle = colormodel + '(' + fmt(c).join(',') + ')';\n                    } else {\n                        // Return a transparent pixel\n                        context.fillStyle = 'rgba(0,0,0,0)';\n                    }\n                    context.fillRect(ipx0, jpx0, ipx1 - ipx0, jpx1 - jpx0);\n                }\n            }\n\n            return canvas;\n        }\n\n        var image3 = plotGroup.selectAll('image')\n            .data([cd]);\n\n        image3.enter().append('svg:image').attr({\n            xmlns: xmlnsNamespaces.svg,\n            preserveAspectRatio: 'none'\n        });\n\n        image3.exit().remove();\n\n        // Pixelated image rendering\n        // http://phrogz.net/tmp/canvas_image_zoom.html\n        // https://developer.mozilla.org/en-US/docs/Web/CSS/image-rendering\n        var style = 'image-rendering: optimizeSpeed; image-rendering: -moz-crisp-edges; image-rendering: -o-crisp-edges; image-rendering: -webkit-optimize-contrast; image-rendering: optimize-contrast; image-rendering: crisp-edges; image-rendering: pixelated;';\n        if(fastImage) {\n            var xRange = Lib.simpleMap(xa.range, xa.r2l);\n            var yRange = Lib.simpleMap(ya.range, ya.r2l);\n\n            var flipX = xRange[1] < xRange[0];\n            var flipY = yRange[1] > yRange[0];\n            if(flipX || flipY) {\n                var tx = left + imageWidth / 2;\n                var ty = top + imageHeight / 2;\n                style += 'transform:' +\n                    strTranslate(tx + 'px', ty + 'px') +\n                    'scale(' + (flipX ? -1 : 1) + ',' + (flipY ? -1 : 1) + ')' +\n                    strTranslate(-tx + 'px', -ty + 'px') + ';';\n            }\n        }\n        image3.attr('style', style);\n\n        var p = new Promise(function(resolve) {\n            if(trace._hasZ) {\n                resolve();\n            } else if(trace._hasSource) {\n                // Check if canvas already exists and has the right data\n                if(\n                    trace._canvas &&\n                    trace._canvas.el.width === w &&\n                    trace._canvas.el.height === h &&\n                    trace._canvas.source === trace.source\n                ) {\n                    resolve();\n                } else {\n                    // Create a canvas and transfer image onto it to access pixel information\n                    var canvas = document.createElement('canvas');\n                    canvas.width = w;\n                    canvas.height = h;\n                    var context = canvas.getContext('2d');\n\n                    trace._image = trace._image || new Image();\n                    var image = trace._image;\n                    image.onload = function() {\n                        context.drawImage(image, 0, 0);\n                        trace._canvas = {\n                            el: canvas,\n                            source: trace.source\n                        };\n                        resolve();\n                    };\n                    image.setAttribute('src', trace.source);\n                }\n            }\n        })\n        .then(function() {\n            var href, canvas;\n            if(trace._hasZ) {\n                canvas = drawMagnifiedPixelsOnCanvas(function(i, j) {return z[j][i];});\n                href = canvas.toDataURL('image/png');\n            } else if(trace._hasSource) {\n                if(fastImage) {\n                    href = trace.source;\n                } else {\n                    var context = trace._canvas.el.getContext('2d');\n                    var data = context.getImageData(0, 0, w, h).data;\n                    canvas = drawMagnifiedPixelsOnCanvas(function(i, j) {\n                        var index = 4 * (j * w + i);\n                        return [\n                            data[index],\n                            data[index + 1],\n                            data[index + 2],\n                            data[index + 3]\n                        ];\n                    });\n                    href = canvas.toDataURL('image/png');\n                }\n            }\n\n            image3.attr({\n                'xlink:href': href,\n                height: imageHeight,\n                width: imageWidth,\n                x: left,\n                y: top\n            });\n        });\n\n        gd._promises.push(p);\n    });\n};\n"]},"metadata":{},"sourceType":"script"}