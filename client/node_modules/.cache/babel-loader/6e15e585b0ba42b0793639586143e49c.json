{"ast":null,"code":"/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar d3 = require('d3');\n\nvar Lib = require('../../lib');\n\nvar Plots = require('../../plots/plots');\n\nvar Registry = require('../../registry');\n\nvar Events = require('../../lib/events');\n\nvar dragElement = require('../dragelement');\n\nvar Drawing = require('../drawing');\n\nvar Color = require('../color');\n\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nvar handleClick = require('./handle_click');\n\nvar constants = require('./constants');\n\nvar alignmentConstants = require('../../constants/alignment');\n\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar FROM_TL = alignmentConstants.FROM_TL;\nvar FROM_BR = alignmentConstants.FROM_BR;\n\nvar getLegendData = require('./get_legend_data');\n\nvar style = require('./style');\n\nvar helpers = require('./helpers');\n\nmodule.exports = function draw(gd, opts) {\n  var fullLayout = gd._fullLayout;\n  var clipId = 'legend' + fullLayout._uid;\n  var layer; // Check whether this is the main legend (ie. called without any opts)\n\n  if (!opts) {\n    opts = fullLayout.legend || {};\n    opts._main = true;\n    layer = fullLayout._infolayer;\n  } else {\n    layer = opts.layer;\n    clipId += '-hover';\n  }\n\n  if (!layer) return;\n  if (!gd._legendMouseDownTime) gd._legendMouseDownTime = 0;\n  var legendData;\n\n  if (opts._main) {\n    if (!gd.calcdata) return;\n    legendData = fullLayout.showlegend && getLegendData(gd.calcdata, opts);\n  } else {\n    if (!opts.entries) return;\n    legendData = getLegendData(opts.entries, opts);\n  }\n\n  var hiddenSlices = fullLayout.hiddenlabels || [];\n\n  if (opts._main && (!fullLayout.showlegend || !legendData.length)) {\n    layer.selectAll('.legend').remove();\n\n    fullLayout._topdefs.select('#' + clipId).remove();\n\n    return Plots.autoMargin(gd, 'legend');\n  }\n\n  var legend = Lib.ensureSingle(layer, 'g', 'legend', function (s) {\n    if (opts._main) s.attr('pointer-events', 'all');\n  });\n  var clipPath = Lib.ensureSingleById(fullLayout._topdefs, 'clipPath', clipId, function (s) {\n    s.append('rect');\n  });\n  var bg = Lib.ensureSingle(legend, 'rect', 'bg', function (s) {\n    s.attr('shape-rendering', 'crispEdges');\n  });\n  bg.call(Color.stroke, opts.bordercolor).call(Color.fill, opts.bgcolor).style('stroke-width', opts.borderwidth + 'px');\n  var scrollBox = Lib.ensureSingle(legend, 'g', 'scrollbox');\n  var title = opts.title;\n  opts._titleWidth = 0;\n  opts._titleHeight = 0;\n\n  if (title.text) {\n    var titleEl = Lib.ensureSingle(scrollBox, 'text', 'legendtitletext');\n    titleEl.attr('text-anchor', 'start').call(Drawing.font, title.font).text(title.text);\n    textLayout(titleEl, scrollBox, gd, opts); // handle mathjax or multi-line text and compute title height\n  } else {\n    scrollBox.selectAll('.legendtitletext').remove();\n  }\n\n  var scrollBar = Lib.ensureSingle(legend, 'rect', 'scrollbar', function (s) {\n    s.attr(constants.scrollBarEnterAttrs).call(Color.fill, constants.scrollBarColor);\n  });\n  var groups = scrollBox.selectAll('g.groups').data(legendData);\n  groups.enter().append('g').attr('class', 'groups');\n  groups.exit().remove();\n  var traces = groups.selectAll('g.traces').data(Lib.identity);\n  traces.enter().append('g').attr('class', 'traces');\n  traces.exit().remove();\n  traces.style('opacity', function (d) {\n    var trace = d[0].trace;\n\n    if (Registry.traceIs(trace, 'pie-like')) {\n      return hiddenSlices.indexOf(d[0].label) !== -1 ? 0.5 : 1;\n    } else {\n      return trace.visible === 'legendonly' ? 0.5 : 1;\n    }\n  }).each(function () {\n    d3.select(this).call(drawTexts, gd, opts);\n  }).call(style, gd, opts).each(function () {\n    if (opts._main) d3.select(this).call(setupTraceToggle, gd);\n  });\n  Lib.syncOrAsync([Plots.previousPromises, function () {\n    return computeLegendDimensions(gd, groups, traces, opts);\n  }, function () {\n    // IF expandMargin return a Promise (which is truthy),\n    // we're under a doAutoMargin redraw, so we don't have to\n    // draw the remaining pieces below\n    if (opts._main && expandMargin(gd)) return;\n    var gs = fullLayout._size;\n    var bw = opts.borderwidth;\n\n    var lx = gs.l + gs.w * opts.x - FROM_TL[getXanchor(opts)] * opts._width;\n\n    var ly = gs.t + gs.h * (1 - opts.y) - FROM_TL[getYanchor(opts)] * opts._effHeight;\n\n    if (opts._main && fullLayout.margin.autoexpand) {\n      var lx0 = lx;\n      var ly0 = ly;\n      lx = Lib.constrain(lx, 0, fullLayout.width - opts._width);\n      ly = Lib.constrain(ly, 0, fullLayout.height - opts._effHeight);\n\n      if (lx !== lx0) {\n        Lib.log('Constrain legend.x to make legend fit inside graph');\n      }\n\n      if (ly !== ly0) {\n        Lib.log('Constrain legend.y to make legend fit inside graph');\n      }\n    } // Set size and position of all the elements that make up a legend:\n    // legend, background and border, scroll box and scroll bar as well as title\n\n\n    if (opts._main) Drawing.setTranslate(legend, lx, ly); // to be safe, remove previous listeners\n\n    scrollBar.on('.drag', null);\n    legend.on('wheel', null);\n\n    if (!opts._main || opts._height <= opts._maxHeight || gd._context.staticPlot) {\n      // if scrollbar should not be shown.\n      var height = opts._effHeight; // if not the main legend, let it be its full size\n\n      if (!opts._main) height = opts._height;\n      bg.attr({\n        width: opts._width - bw,\n        height: height - bw,\n        x: bw / 2,\n        y: bw / 2\n      });\n      Drawing.setTranslate(scrollBox, 0, 0);\n      clipPath.select('rect').attr({\n        width: opts._width - 2 * bw,\n        height: height - 2 * bw,\n        x: bw,\n        y: bw\n      });\n      Drawing.setClipUrl(scrollBox, clipId, gd);\n      Drawing.setRect(scrollBar, 0, 0, 0, 0);\n      delete opts._scrollY;\n    } else {\n      var scrollBarHeight = Math.max(constants.scrollBarMinHeight, opts._effHeight * opts._effHeight / opts._height);\n      var scrollBarYMax = opts._effHeight - scrollBarHeight - 2 * constants.scrollBarMargin;\n      var scrollBoxYMax = opts._height - opts._effHeight;\n      var scrollRatio = scrollBarYMax / scrollBoxYMax;\n      var scrollBoxY = Math.min(opts._scrollY || 0, scrollBoxYMax); // increase the background and clip-path width\n      // by the scrollbar width and margin\n\n      bg.attr({\n        width: opts._width - 2 * bw + constants.scrollBarWidth + constants.scrollBarMargin,\n        height: opts._effHeight - bw,\n        x: bw / 2,\n        y: bw / 2\n      });\n      clipPath.select('rect').attr({\n        width: opts._width - 2 * bw + constants.scrollBarWidth + constants.scrollBarMargin,\n        height: opts._effHeight - 2 * bw,\n        x: bw,\n        y: bw + scrollBoxY\n      });\n      Drawing.setClipUrl(scrollBox, clipId, gd);\n      scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio); // scroll legend by mousewheel or touchpad swipe up/down\n\n      legend.on('wheel', function () {\n        scrollBoxY = Lib.constrain(opts._scrollY + d3.event.deltaY / scrollBarYMax * scrollBoxYMax, 0, scrollBoxYMax);\n        scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n\n        if (scrollBoxY !== 0 && scrollBoxY !== scrollBoxYMax) {\n          d3.event.preventDefault();\n        }\n      });\n      var eventY0, eventY1, scrollBoxY0;\n\n      var getScrollBarDragY = function (scrollBoxY0, eventY0, eventY1) {\n        var y = (eventY1 - eventY0) / scrollRatio + scrollBoxY0;\n        return Lib.constrain(y, 0, scrollBoxYMax);\n      };\n\n      var getNaturalDragY = function (scrollBoxY0, eventY0, eventY1) {\n        var y = (eventY0 - eventY1) / scrollRatio + scrollBoxY0;\n        return Lib.constrain(y, 0, scrollBoxYMax);\n      }; // scroll legend by dragging scrollBAR\n\n\n      var scrollBarDrag = d3.behavior.drag().on('dragstart', function () {\n        var e = d3.event.sourceEvent;\n\n        if (e.type === 'touchstart') {\n          eventY0 = e.changedTouches[0].clientY;\n        } else {\n          eventY0 = e.clientY;\n        }\n\n        scrollBoxY0 = scrollBoxY;\n      }).on('drag', function () {\n        var e = d3.event.sourceEvent;\n        if (e.buttons === 2 || e.ctrlKey) return;\n\n        if (e.type === 'touchmove') {\n          eventY1 = e.changedTouches[0].clientY;\n        } else {\n          eventY1 = e.clientY;\n        }\n\n        scrollBoxY = getScrollBarDragY(scrollBoxY0, eventY0, eventY1);\n        scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n      });\n      scrollBar.call(scrollBarDrag); // scroll legend by touch-dragging scrollBOX\n\n      var scrollBoxTouchDrag = d3.behavior.drag().on('dragstart', function () {\n        var e = d3.event.sourceEvent;\n\n        if (e.type === 'touchstart') {\n          eventY0 = e.changedTouches[0].clientY;\n          scrollBoxY0 = scrollBoxY;\n        }\n      }).on('drag', function () {\n        var e = d3.event.sourceEvent;\n\n        if (e.type === 'touchmove') {\n          eventY1 = e.changedTouches[0].clientY;\n          scrollBoxY = getNaturalDragY(scrollBoxY0, eventY0, eventY1);\n          scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n        }\n      });\n      scrollBox.call(scrollBoxTouchDrag);\n    }\n\n    function scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio) {\n      opts._scrollY = gd._fullLayout.legend._scrollY = scrollBoxY;\n      Drawing.setTranslate(scrollBox, 0, -scrollBoxY);\n      Drawing.setRect(scrollBar, opts._width, constants.scrollBarMargin + scrollBoxY * scrollRatio, constants.scrollBarWidth, scrollBarHeight);\n      clipPath.select('rect').attr('y', bw + scrollBoxY);\n    }\n\n    if (gd._context.edits.legendPosition) {\n      var xf, yf, x0, y0;\n      legend.classed('cursor-move', true);\n      dragElement.init({\n        element: legend.node(),\n        gd: gd,\n        prepFn: function () {\n          var transform = Drawing.getTranslate(legend);\n          x0 = transform.x;\n          y0 = transform.y;\n        },\n        moveFn: function (dx, dy) {\n          var newX = x0 + dx;\n          var newY = y0 + dy;\n          Drawing.setTranslate(legend, newX, newY);\n          xf = dragElement.align(newX, 0, gs.l, gs.l + gs.w, opts.xanchor);\n          yf = dragElement.align(newY, 0, gs.t + gs.h, gs.t, opts.yanchor);\n        },\n        doneFn: function () {\n          if (xf !== undefined && yf !== undefined) {\n            Registry.call('_guiRelayout', gd, {\n              'legend.x': xf,\n              'legend.y': yf\n            });\n          }\n        },\n        clickFn: function (numClicks, e) {\n          var clickedTrace = layer.selectAll('g.traces').filter(function () {\n            var bbox = this.getBoundingClientRect();\n            return e.clientX >= bbox.left && e.clientX <= bbox.right && e.clientY >= bbox.top && e.clientY <= bbox.bottom;\n          });\n\n          if (clickedTrace.size() > 0) {\n            clickOrDoubleClick(gd, legend, clickedTrace, numClicks, e);\n          }\n        }\n      });\n    }\n  }], gd);\n};\n\nfunction clickOrDoubleClick(gd, legend, legendItem, numClicks, evt) {\n  var trace = legendItem.data()[0][0].trace;\n  var evtData = {\n    event: evt,\n    node: legendItem.node(),\n    curveNumber: trace.index,\n    expandedIndex: trace._expandedIndex,\n    data: gd.data,\n    layout: gd.layout,\n    frames: gd._transitionData._frames,\n    config: gd._context,\n    fullData: gd._fullData,\n    fullLayout: gd._fullLayout\n  };\n\n  if (trace._group) {\n    evtData.group = trace._group;\n  }\n\n  if (Registry.traceIs(trace, 'pie-like')) {\n    evtData.label = legendItem.datum()[0].label;\n  }\n\n  var clickVal = Events.triggerHandler(gd, 'plotly_legendclick', evtData);\n  if (clickVal === false) return;\n\n  if (numClicks === 1) {\n    legend._clickTimeout = setTimeout(function () {\n      handleClick(legendItem, gd, numClicks);\n    }, gd._context.doubleClickDelay);\n  } else if (numClicks === 2) {\n    if (legend._clickTimeout) clearTimeout(legend._clickTimeout);\n    gd._legendMouseDownTime = 0;\n    var dblClickVal = Events.triggerHandler(gd, 'plotly_legenddoubleclick', evtData);\n    if (dblClickVal !== false) handleClick(legendItem, gd, numClicks);\n  }\n}\n\nfunction drawTexts(g, gd, opts) {\n  var legendItem = g.data()[0][0];\n  var trace = legendItem.trace;\n  var isPieLike = Registry.traceIs(trace, 'pie-like');\n  var traceIndex = trace.index;\n  var isEditable = opts._main && gd._context.edits.legendText && !isPieLike;\n  var maxNameLength = opts._maxNameLength;\n  var name;\n\n  if (!opts.entries) {\n    name = isPieLike ? legendItem.label : trace.name;\n\n    if (trace._meta) {\n      name = Lib.templateString(name, trace._meta);\n    }\n  } else {\n    name = legendItem.text;\n  }\n\n  var textEl = Lib.ensureSingle(g, 'text', 'legendtext');\n  textEl.attr('text-anchor', 'start').call(Drawing.font, opts.font).text(isEditable ? ensureLength(name, maxNameLength) : name);\n  var textGap = opts.itemwidth + constants.itemGap * 2;\n  svgTextUtils.positionText(textEl, textGap, 0);\n\n  if (isEditable) {\n    textEl.call(svgTextUtils.makeEditable, {\n      gd: gd,\n      text: name\n    }).call(textLayout, g, gd, opts).on('edit', function (newName) {\n      this.text(ensureLength(newName, maxNameLength)).call(textLayout, g, gd, opts);\n      var fullInput = legendItem.trace._fullInput || {};\n      var update = {};\n\n      if (Registry.hasTransform(fullInput, 'groupby')) {\n        var groupbyIndices = Registry.getTransformIndices(fullInput, 'groupby');\n        var index = groupbyIndices[groupbyIndices.length - 1];\n        var kcont = Lib.keyedContainer(fullInput, 'transforms[' + index + '].styles', 'target', 'value.name');\n        kcont.set(legendItem.trace._group, newName);\n        update = kcont.constructUpdate();\n      } else {\n        update.name = newName;\n      }\n\n      return Registry.call('_guiRestyle', gd, update, traceIndex);\n    });\n  } else {\n    textLayout(textEl, g, gd, opts);\n  }\n}\n/*\n * Make sure we have a reasonably clickable region.\n * If this string is missing or very short, pad it with spaces out to at least\n * 4 characters, up to the max length of other labels, on the assumption that\n * most characters are wider than spaces so a string of spaces will usually be\n * no wider than the real labels.\n */\n\n\nfunction ensureLength(str, maxLength) {\n  var targetLength = Math.max(4, maxLength);\n  if (str && str.trim().length >= targetLength / 2) return str;\n  str = str || '';\n\n  for (var i = targetLength - str.length; i > 0; i--) str += ' ';\n\n  return str;\n}\n\nfunction setupTraceToggle(g, gd) {\n  var doubleClickDelay = gd._context.doubleClickDelay;\n  var newMouseDownTime;\n  var numClicks = 1;\n  var traceToggle = Lib.ensureSingle(g, 'rect', 'legendtoggle', function (s) {\n    if (!gd._context.staticPlot) {\n      s.style('cursor', 'pointer').attr('pointer-events', 'all');\n    }\n\n    s.call(Color.fill, 'rgba(0,0,0,0)');\n  });\n  if (gd._context.staticPlot) return;\n  traceToggle.on('mousedown', function () {\n    newMouseDownTime = new Date().getTime();\n\n    if (newMouseDownTime - gd._legendMouseDownTime < doubleClickDelay) {\n      // in a click train\n      numClicks += 1;\n    } else {\n      // new click train\n      numClicks = 1;\n      gd._legendMouseDownTime = newMouseDownTime;\n    }\n  });\n  traceToggle.on('mouseup', function () {\n    if (gd._dragged || gd._editing) return;\n    var legend = gd._fullLayout.legend;\n\n    if (new Date().getTime() - gd._legendMouseDownTime > doubleClickDelay) {\n      numClicks = Math.max(numClicks - 1, 1);\n    }\n\n    clickOrDoubleClick(gd, legend, g, numClicks, d3.event);\n  });\n}\n\nfunction textLayout(s, g, gd, opts) {\n  if (!opts._main) s.attr('data-notex', true); // do not process MathJax if not main\n\n  svgTextUtils.convertToTspans(s, gd, function () {\n    computeTextDimensions(g, gd, opts);\n  });\n}\n\nfunction computeTextDimensions(g, gd, opts) {\n  var legendItem = g.data()[0][0];\n\n  if (opts._main && legendItem && !legendItem.trace.showlegend) {\n    g.remove();\n    return;\n  }\n\n  var mathjaxGroup = g.select('g[class*=math-group]');\n  var mathjaxNode = mathjaxGroup.node();\n  if (!opts) opts = gd._fullLayout.legend;\n  var bw = opts.borderwidth;\n  var lineHeight = (legendItem ? opts : opts.title).font.size * LINE_SPACING;\n  var height, width;\n\n  if (mathjaxNode) {\n    var mathjaxBB = Drawing.bBox(mathjaxNode);\n    height = mathjaxBB.height;\n    width = mathjaxBB.width;\n\n    if (legendItem) {\n      Drawing.setTranslate(mathjaxGroup, 0, height * 0.25);\n    } else {\n      // case of title\n      Drawing.setTranslate(mathjaxGroup, bw, height * 0.75 + bw);\n    }\n  } else {\n    var textEl = g.select(legendItem ? '.legendtext' : '.legendtitletext');\n    var textLines = svgTextUtils.lineCount(textEl);\n    var textNode = textEl.node();\n    height = lineHeight * textLines;\n    width = textNode ? Drawing.bBox(textNode).width : 0; // approximation to height offset to center the font\n    // to avoid getBoundingClientRect\n\n    var textY = lineHeight * ((textLines - 1) / 2 - 0.3);\n\n    if (legendItem) {\n      var textGap = opts.itemwidth + constants.itemGap * 2;\n      svgTextUtils.positionText(textEl, textGap, -textY);\n    } else {\n      // case of title\n      svgTextUtils.positionText(textEl, constants.titlePad + bw, lineHeight + bw);\n    }\n  }\n\n  if (legendItem) {\n    legendItem.lineHeight = lineHeight;\n    legendItem.height = Math.max(height, 16) + 3;\n    legendItem.width = width;\n  } else {\n    // case of title\n    opts._titleWidth = width;\n    opts._titleHeight = height;\n  }\n}\n\nfunction getTitleSize(opts) {\n  var w = 0;\n  var h = 0;\n  var side = opts.title.side;\n\n  if (side) {\n    if (side.indexOf('left') !== -1) {\n      w = opts._titleWidth;\n    }\n\n    if (side.indexOf('top') !== -1) {\n      h = opts._titleHeight;\n    }\n  }\n\n  return [w, h];\n}\n/*\n * Computes in fullLayout.legend:\n *\n *  - _height: legend height including items past scrollbox height\n *  - _maxHeight: maximum legend height before scrollbox is required\n *  - _effHeight: legend height w/ or w/o scrollbox\n *\n *  - _width: legend width\n *  - _maxWidth (for orientation:h only): maximum width before starting new row\n */\n\n\nfunction computeLegendDimensions(gd, groups, traces, opts) {\n  var fullLayout = gd._fullLayout;\n  if (!opts) opts = fullLayout.legend;\n  var gs = fullLayout._size;\n  var isVertical = helpers.isVertical(opts);\n  var isGrouped = helpers.isGrouped(opts);\n  var bw = opts.borderwidth;\n  var bw2 = 2 * bw;\n  var itemGap = constants.itemGap;\n  var textGap = opts.itemwidth + itemGap * 2;\n  var endPad = 2 * (bw + itemGap);\n  var yanchor = getYanchor(opts);\n  var isBelowPlotArea = opts.y < 0 || opts.y === 0 && yanchor === 'top';\n  var isAbovePlotArea = opts.y > 1 || opts.y === 1 && yanchor === 'bottom'; // - if below/above plot area, give it the maximum potential margin-push value\n  // - otherwise, extend the height of the plot area\n\n  opts._maxHeight = Math.max(isBelowPlotArea || isAbovePlotArea ? fullLayout.height / 2 : gs.h, 30);\n  var toggleRectWidth = 0;\n  opts._width = 0;\n  opts._height = 0;\n  var titleSize = getTitleSize(opts);\n\n  if (isVertical) {\n    traces.each(function (d) {\n      var h = d[0].height;\n      Drawing.setTranslate(this, bw + titleSize[0], bw + titleSize[1] + opts._height + h / 2 + itemGap);\n      opts._height += h;\n      opts._width = Math.max(opts._width, d[0].width);\n    });\n    toggleRectWidth = textGap + opts._width;\n    opts._width += itemGap + textGap + bw2;\n    opts._height += endPad;\n\n    if (isGrouped) {\n      groups.each(function (d, i) {\n        Drawing.setTranslate(this, 0, i * opts.tracegroupgap);\n      });\n      opts._height += (opts._lgroupsLength - 1) * opts.tracegroupgap;\n    }\n  } else {\n    var xanchor = getXanchor(opts);\n    var isLeftOfPlotArea = opts.x < 0 || opts.x === 0 && xanchor === 'right';\n    var isRightOfPlotArea = opts.x > 1 || opts.x === 1 && xanchor === 'left';\n    var isBeyondPlotAreaY = isAbovePlotArea || isBelowPlotArea;\n    var hw = fullLayout.width / 2; // - if placed within x-margins, extend the width of the plot area\n    // - else if below/above plot area and anchored in the margin, extend to opposite margin,\n    // - otherwise give it the maximum potential margin-push value\n\n    opts._maxWidth = Math.max(isLeftOfPlotArea ? isBeyondPlotAreaY && xanchor === 'left' ? gs.l + gs.w : hw : isRightOfPlotArea ? isBeyondPlotAreaY && xanchor === 'right' ? gs.r + gs.w : hw : gs.w, 2 * textGap);\n    var maxItemWidth = 0;\n    var combinedItemWidth = 0;\n    traces.each(function (d) {\n      var w = d[0].width + textGap;\n      maxItemWidth = Math.max(maxItemWidth, w);\n      combinedItemWidth += w;\n    });\n    toggleRectWidth = null;\n    var maxRowWidth = 0;\n\n    if (isGrouped) {\n      var maxGroupHeightInRow = 0;\n      var groupOffsetX = 0;\n      var groupOffsetY = 0;\n      groups.each(function () {\n        var maxWidthInGroup = 0;\n        var offsetY = 0;\n        d3.select(this).selectAll('g.traces').each(function (d) {\n          var h = d[0].height;\n          Drawing.setTranslate(this, titleSize[0], titleSize[1] + bw + itemGap + h / 2 + offsetY);\n          offsetY += h;\n          maxWidthInGroup = Math.max(maxWidthInGroup, textGap + d[0].width);\n        });\n        maxGroupHeightInRow = Math.max(maxGroupHeightInRow, offsetY);\n        var next = maxWidthInGroup + itemGap;\n\n        if (next + bw + groupOffsetX > opts._maxWidth) {\n          maxRowWidth = Math.max(maxRowWidth, groupOffsetX);\n          groupOffsetX = 0;\n          groupOffsetY += maxGroupHeightInRow + opts.tracegroupgap;\n          maxGroupHeightInRow = offsetY;\n        }\n\n        Drawing.setTranslate(this, groupOffsetX, groupOffsetY);\n        groupOffsetX += next;\n      });\n      opts._width = Math.max(maxRowWidth, groupOffsetX) + bw;\n      opts._height = groupOffsetY + maxGroupHeightInRow + endPad;\n    } else {\n      var nTraces = traces.size();\n      var oneRowLegend = combinedItemWidth + bw2 + (nTraces - 1) * itemGap < opts._maxWidth;\n      var maxItemHeightInRow = 0;\n      var offsetX = 0;\n      var offsetY = 0;\n      var rowWidth = 0;\n      traces.each(function (d) {\n        var h = d[0].height;\n        var w = textGap + d[0].width;\n        var next = (oneRowLegend ? w : maxItemWidth) + itemGap;\n\n        if (next + bw + offsetX - itemGap >= opts._maxWidth) {\n          maxRowWidth = Math.max(maxRowWidth, rowWidth);\n          offsetX = 0;\n          offsetY += maxItemHeightInRow;\n          opts._height += maxItemHeightInRow;\n          maxItemHeightInRow = 0;\n        }\n\n        Drawing.setTranslate(this, titleSize[0] + bw + offsetX, titleSize[1] + bw + offsetY + h / 2 + itemGap);\n        rowWidth = offsetX + w + itemGap;\n        offsetX += next;\n        maxItemHeightInRow = Math.max(maxItemHeightInRow, h);\n      });\n\n      if (oneRowLegend) {\n        opts._width = offsetX + bw2;\n        opts._height = maxItemHeightInRow + endPad;\n      } else {\n        opts._width = Math.max(maxRowWidth, rowWidth) + bw2;\n        opts._height += maxItemHeightInRow + endPad;\n      }\n    }\n  }\n\n  opts._width = Math.ceil(Math.max(opts._width + titleSize[0], opts._titleWidth + 2 * (bw + constants.titlePad)));\n  opts._height = Math.ceil(Math.max(opts._height + titleSize[1], opts._titleHeight + 2 * (bw + constants.itemGap)));\n  opts._effHeight = Math.min(opts._height, opts._maxHeight);\n  var edits = gd._context.edits;\n  var isEditable = edits.legendText || edits.legendPosition;\n  traces.each(function (d) {\n    var traceToggle = d3.select(this).select('.legendtoggle');\n    var h = d[0].height;\n    var w = isEditable ? textGap : toggleRectWidth || textGap + d[0].width;\n    if (!isVertical) w += itemGap / 2;\n    Drawing.setRect(traceToggle, 0, -h / 2, w, h);\n  });\n}\n\nfunction expandMargin(gd) {\n  var fullLayout = gd._fullLayout;\n  var opts = fullLayout.legend;\n  var xanchor = getXanchor(opts);\n  var yanchor = getYanchor(opts);\n  return Plots.autoMargin(gd, 'legend', {\n    x: opts.x,\n    y: opts.y,\n    l: opts._width * FROM_TL[xanchor],\n    r: opts._width * FROM_BR[xanchor],\n    b: opts._effHeight * FROM_BR[yanchor],\n    t: opts._effHeight * FROM_TL[yanchor]\n  });\n}\n\nfunction getXanchor(opts) {\n  return Lib.isRightAnchor(opts) ? 'right' : Lib.isCenterAnchor(opts) ? 'center' : 'left';\n}\n\nfunction getYanchor(opts) {\n  return Lib.isBottomAnchor(opts) ? 'bottom' : Lib.isMiddleAnchor(opts) ? 'middle' : 'top';\n}","map":{"version":3,"sources":["/Users/caseyrudick/Documents/landsharkrefactored-copy/client/node_modules/plotly.js/src/components/legend/draw.js"],"names":["d3","require","Lib","Plots","Registry","Events","dragElement","Drawing","Color","svgTextUtils","handleClick","constants","alignmentConstants","LINE_SPACING","FROM_TL","FROM_BR","getLegendData","style","helpers","module","exports","draw","gd","opts","fullLayout","_fullLayout","clipId","_uid","layer","legend","_main","_infolayer","_legendMouseDownTime","legendData","calcdata","showlegend","entries","hiddenSlices","hiddenlabels","length","selectAll","remove","_topdefs","select","autoMargin","ensureSingle","s","attr","clipPath","ensureSingleById","append","bg","call","stroke","bordercolor","fill","bgcolor","borderwidth","scrollBox","title","_titleWidth","_titleHeight","text","titleEl","font","textLayout","scrollBar","scrollBarEnterAttrs","scrollBarColor","groups","data","enter","exit","traces","identity","d","trace","traceIs","indexOf","label","visible","each","drawTexts","setupTraceToggle","syncOrAsync","previousPromises","computeLegendDimensions","expandMargin","gs","_size","bw","lx","l","w","x","getXanchor","_width","ly","t","h","y","getYanchor","_effHeight","margin","autoexpand","lx0","ly0","constrain","width","height","log","setTranslate","on","_height","_maxHeight","_context","staticPlot","setClipUrl","setRect","_scrollY","scrollBarHeight","Math","max","scrollBarMinHeight","scrollBarYMax","scrollBarMargin","scrollBoxYMax","scrollRatio","scrollBoxY","min","scrollBarWidth","scrollHandler","event","deltaY","preventDefault","eventY0","eventY1","scrollBoxY0","getScrollBarDragY","getNaturalDragY","scrollBarDrag","behavior","drag","e","sourceEvent","type","changedTouches","clientY","buttons","ctrlKey","scrollBoxTouchDrag","edits","legendPosition","xf","yf","x0","y0","classed","init","element","node","prepFn","transform","getTranslate","moveFn","dx","dy","newX","newY","align","xanchor","yanchor","doneFn","undefined","clickFn","numClicks","clickedTrace","filter","bbox","getBoundingClientRect","clientX","left","right","top","bottom","size","clickOrDoubleClick","legendItem","evt","evtData","curveNumber","index","expandedIndex","_expandedIndex","layout","frames","_transitionData","_frames","config","fullData","_fullData","_group","group","datum","clickVal","triggerHandler","_clickTimeout","setTimeout","doubleClickDelay","clearTimeout","dblClickVal","g","isPieLike","traceIndex","isEditable","legendText","maxNameLength","_maxNameLength","name","_meta","templateString","textEl","ensureLength","textGap","itemwidth","itemGap","positionText","makeEditable","newName","fullInput","_fullInput","update","hasTransform","groupbyIndices","getTransformIndices","kcont","keyedContainer","set","constructUpdate","str","maxLength","targetLength","trim","i","newMouseDownTime","traceToggle","Date","getTime","_dragged","_editing","convertToTspans","computeTextDimensions","mathjaxGroup","mathjaxNode","lineHeight","mathjaxBB","bBox","textLines","lineCount","textNode","textY","titlePad","getTitleSize","side","isVertical","isGrouped","bw2","endPad","isBelowPlotArea","isAbovePlotArea","toggleRectWidth","titleSize","tracegroupgap","_lgroupsLength","isLeftOfPlotArea","isRightOfPlotArea","isBeyondPlotAreaY","hw","_maxWidth","r","maxItemWidth","combinedItemWidth","maxRowWidth","maxGroupHeightInRow","groupOffsetX","groupOffsetY","maxWidthInGroup","offsetY","next","nTraces","oneRowLegend","maxItemHeightInRow","offsetX","rowWidth","ceil","b","isRightAnchor","isCenterAnchor","isBottomAnchor","isMiddleAnchor"],"mappings":"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","sourcesContent":["/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n\n'use strict';\n\nvar d3 = require('d3');\n\nvar Lib = require('../../lib');\nvar Plots = require('../../plots/plots');\nvar Registry = require('../../registry');\nvar Events = require('../../lib/events');\nvar dragElement = require('../dragelement');\nvar Drawing = require('../drawing');\nvar Color = require('../color');\nvar svgTextUtils = require('../../lib/svg_text_utils');\nvar handleClick = require('./handle_click');\n\nvar constants = require('./constants');\nvar alignmentConstants = require('../../constants/alignment');\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar FROM_TL = alignmentConstants.FROM_TL;\nvar FROM_BR = alignmentConstants.FROM_BR;\n\nvar getLegendData = require('./get_legend_data');\nvar style = require('./style');\nvar helpers = require('./helpers');\n\nmodule.exports = function draw(gd, opts) {\n    var fullLayout = gd._fullLayout;\n    var clipId = 'legend' + fullLayout._uid;\n    var layer;\n\n    // Check whether this is the main legend (ie. called without any opts)\n    if(!opts) {\n        opts = fullLayout.legend || {};\n        opts._main = true;\n        layer = fullLayout._infolayer;\n    } else {\n        layer = opts.layer;\n        clipId += '-hover';\n    }\n\n    if(!layer) return;\n\n    if(!gd._legendMouseDownTime) gd._legendMouseDownTime = 0;\n\n    var legendData;\n    if(opts._main) {\n        if(!gd.calcdata) return;\n        legendData = fullLayout.showlegend && getLegendData(gd.calcdata, opts);\n    } else {\n        if(!opts.entries) return;\n        legendData = getLegendData(opts.entries, opts);\n    }\n\n    var hiddenSlices = fullLayout.hiddenlabels || [];\n\n    if(opts._main && (!fullLayout.showlegend || !legendData.length)) {\n        layer.selectAll('.legend').remove();\n        fullLayout._topdefs.select('#' + clipId).remove();\n        return Plots.autoMargin(gd, 'legend');\n    }\n\n    var legend = Lib.ensureSingle(layer, 'g', 'legend', function(s) {\n        if(opts._main) s.attr('pointer-events', 'all');\n    });\n\n    var clipPath = Lib.ensureSingleById(fullLayout._topdefs, 'clipPath', clipId, function(s) {\n        s.append('rect');\n    });\n\n    var bg = Lib.ensureSingle(legend, 'rect', 'bg', function(s) {\n        s.attr('shape-rendering', 'crispEdges');\n    });\n    bg.call(Color.stroke, opts.bordercolor)\n        .call(Color.fill, opts.bgcolor)\n        .style('stroke-width', opts.borderwidth + 'px');\n\n    var scrollBox = Lib.ensureSingle(legend, 'g', 'scrollbox');\n\n    var title = opts.title;\n    opts._titleWidth = 0;\n    opts._titleHeight = 0;\n    if(title.text) {\n        var titleEl = Lib.ensureSingle(scrollBox, 'text', 'legendtitletext');\n        titleEl.attr('text-anchor', 'start')\n            .call(Drawing.font, title.font)\n            .text(title.text);\n\n        textLayout(titleEl, scrollBox, gd, opts); // handle mathjax or multi-line text and compute title height\n    } else {\n        scrollBox.selectAll('.legendtitletext').remove();\n    }\n\n    var scrollBar = Lib.ensureSingle(legend, 'rect', 'scrollbar', function(s) {\n        s.attr(constants.scrollBarEnterAttrs)\n         .call(Color.fill, constants.scrollBarColor);\n    });\n\n    var groups = scrollBox.selectAll('g.groups').data(legendData);\n    groups.enter().append('g').attr('class', 'groups');\n    groups.exit().remove();\n\n    var traces = groups.selectAll('g.traces').data(Lib.identity);\n    traces.enter().append('g').attr('class', 'traces');\n    traces.exit().remove();\n\n    traces.style('opacity', function(d) {\n        var trace = d[0].trace;\n        if(Registry.traceIs(trace, 'pie-like')) {\n            return hiddenSlices.indexOf(d[0].label) !== -1 ? 0.5 : 1;\n        } else {\n            return trace.visible === 'legendonly' ? 0.5 : 1;\n        }\n    })\n    .each(function() { d3.select(this).call(drawTexts, gd, opts); })\n    .call(style, gd, opts)\n    .each(function() { if(opts._main) d3.select(this).call(setupTraceToggle, gd); });\n\n    Lib.syncOrAsync([\n        Plots.previousPromises,\n        function() { return computeLegendDimensions(gd, groups, traces, opts); },\n        function() {\n            // IF expandMargin return a Promise (which is truthy),\n            // we're under a doAutoMargin redraw, so we don't have to\n            // draw the remaining pieces below\n            if(opts._main && expandMargin(gd)) return;\n\n            var gs = fullLayout._size;\n            var bw = opts.borderwidth;\n\n            var lx = gs.l + gs.w * opts.x - FROM_TL[getXanchor(opts)] * opts._width;\n            var ly = gs.t + gs.h * (1 - opts.y) - FROM_TL[getYanchor(opts)] * opts._effHeight;\n\n            if(opts._main && fullLayout.margin.autoexpand) {\n                var lx0 = lx;\n                var ly0 = ly;\n\n                lx = Lib.constrain(lx, 0, fullLayout.width - opts._width);\n                ly = Lib.constrain(ly, 0, fullLayout.height - opts._effHeight);\n\n                if(lx !== lx0) {\n                    Lib.log('Constrain legend.x to make legend fit inside graph');\n                }\n                if(ly !== ly0) {\n                    Lib.log('Constrain legend.y to make legend fit inside graph');\n                }\n            }\n\n            // Set size and position of all the elements that make up a legend:\n            // legend, background and border, scroll box and scroll bar as well as title\n            if(opts._main) Drawing.setTranslate(legend, lx, ly);\n\n            // to be safe, remove previous listeners\n            scrollBar.on('.drag', null);\n            legend.on('wheel', null);\n\n            if(!opts._main || opts._height <= opts._maxHeight || gd._context.staticPlot) {\n                // if scrollbar should not be shown.\n                var height = opts._effHeight;\n\n                // if not the main legend, let it be its full size\n                if(!opts._main) height = opts._height;\n\n                bg.attr({\n                    width: opts._width - bw,\n                    height: height - bw,\n                    x: bw / 2,\n                    y: bw / 2\n                });\n\n                Drawing.setTranslate(scrollBox, 0, 0);\n\n                clipPath.select('rect').attr({\n                    width: opts._width - 2 * bw,\n                    height: height - 2 * bw,\n                    x: bw,\n                    y: bw\n                });\n\n                Drawing.setClipUrl(scrollBox, clipId, gd);\n\n                Drawing.setRect(scrollBar, 0, 0, 0, 0);\n                delete opts._scrollY;\n            } else {\n                var scrollBarHeight = Math.max(constants.scrollBarMinHeight,\n                    opts._effHeight * opts._effHeight / opts._height);\n                var scrollBarYMax = opts._effHeight -\n                    scrollBarHeight -\n                    2 * constants.scrollBarMargin;\n                var scrollBoxYMax = opts._height - opts._effHeight;\n                var scrollRatio = scrollBarYMax / scrollBoxYMax;\n\n                var scrollBoxY = Math.min(opts._scrollY || 0, scrollBoxYMax);\n\n                // increase the background and clip-path width\n                // by the scrollbar width and margin\n                bg.attr({\n                    width: opts._width -\n                        2 * bw +\n                        constants.scrollBarWidth +\n                        constants.scrollBarMargin,\n                    height: opts._effHeight - bw,\n                    x: bw / 2,\n                    y: bw / 2\n                });\n\n                clipPath.select('rect').attr({\n                    width: opts._width -\n                        2 * bw +\n                        constants.scrollBarWidth +\n                        constants.scrollBarMargin,\n                    height: opts._effHeight - 2 * bw,\n                    x: bw,\n                    y: bw + scrollBoxY\n                });\n\n                Drawing.setClipUrl(scrollBox, clipId, gd);\n\n                scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n\n                // scroll legend by mousewheel or touchpad swipe up/down\n                legend.on('wheel', function() {\n                    scrollBoxY = Lib.constrain(\n                        opts._scrollY +\n                            ((d3.event.deltaY / scrollBarYMax) * scrollBoxYMax),\n                        0, scrollBoxYMax);\n                    scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n                    if(scrollBoxY !== 0 && scrollBoxY !== scrollBoxYMax) {\n                        d3.event.preventDefault();\n                    }\n                });\n\n                var eventY0, eventY1, scrollBoxY0;\n\n                var getScrollBarDragY = function(scrollBoxY0, eventY0, eventY1) {\n                    var y = ((eventY1 - eventY0) / scrollRatio) + scrollBoxY0;\n                    return Lib.constrain(y, 0, scrollBoxYMax);\n                };\n\n                var getNaturalDragY = function(scrollBoxY0, eventY0, eventY1) {\n                    var y = ((eventY0 - eventY1) / scrollRatio) + scrollBoxY0;\n                    return Lib.constrain(y, 0, scrollBoxYMax);\n                };\n\n                // scroll legend by dragging scrollBAR\n                var scrollBarDrag = d3.behavior.drag()\n                .on('dragstart', function() {\n                    var e = d3.event.sourceEvent;\n                    if(e.type === 'touchstart') {\n                        eventY0 = e.changedTouches[0].clientY;\n                    } else {\n                        eventY0 = e.clientY;\n                    }\n                    scrollBoxY0 = scrollBoxY;\n                })\n                .on('drag', function() {\n                    var e = d3.event.sourceEvent;\n                    if(e.buttons === 2 || e.ctrlKey) return;\n                    if(e.type === 'touchmove') {\n                        eventY1 = e.changedTouches[0].clientY;\n                    } else {\n                        eventY1 = e.clientY;\n                    }\n                    scrollBoxY = getScrollBarDragY(scrollBoxY0, eventY0, eventY1);\n                    scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n                });\n                scrollBar.call(scrollBarDrag);\n\n                // scroll legend by touch-dragging scrollBOX\n                var scrollBoxTouchDrag = d3.behavior.drag()\n                .on('dragstart', function() {\n                    var e = d3.event.sourceEvent;\n                    if(e.type === 'touchstart') {\n                        eventY0 = e.changedTouches[0].clientY;\n                        scrollBoxY0 = scrollBoxY;\n                    }\n                })\n                .on('drag', function() {\n                    var e = d3.event.sourceEvent;\n                    if(e.type === 'touchmove') {\n                        eventY1 = e.changedTouches[0].clientY;\n                        scrollBoxY = getNaturalDragY(scrollBoxY0, eventY0, eventY1);\n                        scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n                    }\n                });\n                scrollBox.call(scrollBoxTouchDrag);\n            }\n\n            function scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio) {\n                opts._scrollY = gd._fullLayout.legend._scrollY = scrollBoxY;\n                Drawing.setTranslate(scrollBox, 0, -scrollBoxY);\n\n                Drawing.setRect(\n                    scrollBar,\n                    opts._width,\n                    constants.scrollBarMargin + scrollBoxY * scrollRatio,\n                    constants.scrollBarWidth,\n                    scrollBarHeight\n                );\n                clipPath.select('rect').attr('y', bw + scrollBoxY);\n            }\n\n            if(gd._context.edits.legendPosition) {\n                var xf, yf, x0, y0;\n\n                legend.classed('cursor-move', true);\n\n                dragElement.init({\n                    element: legend.node(),\n                    gd: gd,\n                    prepFn: function() {\n                        var transform = Drawing.getTranslate(legend);\n                        x0 = transform.x;\n                        y0 = transform.y;\n                    },\n                    moveFn: function(dx, dy) {\n                        var newX = x0 + dx;\n                        var newY = y0 + dy;\n\n                        Drawing.setTranslate(legend, newX, newY);\n\n                        xf = dragElement.align(newX, 0, gs.l, gs.l + gs.w, opts.xanchor);\n                        yf = dragElement.align(newY, 0, gs.t + gs.h, gs.t, opts.yanchor);\n                    },\n                    doneFn: function() {\n                        if(xf !== undefined && yf !== undefined) {\n                            Registry.call('_guiRelayout', gd, {'legend.x': xf, 'legend.y': yf});\n                        }\n                    },\n                    clickFn: function(numClicks, e) {\n                        var clickedTrace = layer.selectAll('g.traces').filter(function() {\n                            var bbox = this.getBoundingClientRect();\n                            return (\n                                e.clientX >= bbox.left && e.clientX <= bbox.right &&\n                                e.clientY >= bbox.top && e.clientY <= bbox.bottom\n                            );\n                        });\n                        if(clickedTrace.size() > 0) {\n                            clickOrDoubleClick(gd, legend, clickedTrace, numClicks, e);\n                        }\n                    }\n                });\n            }\n        }], gd);\n};\n\nfunction clickOrDoubleClick(gd, legend, legendItem, numClicks, evt) {\n    var trace = legendItem.data()[0][0].trace;\n    var evtData = {\n        event: evt,\n        node: legendItem.node(),\n        curveNumber: trace.index,\n        expandedIndex: trace._expandedIndex,\n        data: gd.data,\n        layout: gd.layout,\n        frames: gd._transitionData._frames,\n        config: gd._context,\n        fullData: gd._fullData,\n        fullLayout: gd._fullLayout\n    };\n\n    if(trace._group) {\n        evtData.group = trace._group;\n    }\n    if(Registry.traceIs(trace, 'pie-like')) {\n        evtData.label = legendItem.datum()[0].label;\n    }\n\n    var clickVal = Events.triggerHandler(gd, 'plotly_legendclick', evtData);\n    if(clickVal === false) return;\n\n    if(numClicks === 1) {\n        legend._clickTimeout = setTimeout(function() {\n            handleClick(legendItem, gd, numClicks);\n        }, gd._context.doubleClickDelay);\n    } else if(numClicks === 2) {\n        if(legend._clickTimeout) clearTimeout(legend._clickTimeout);\n        gd._legendMouseDownTime = 0;\n\n        var dblClickVal = Events.triggerHandler(gd, 'plotly_legenddoubleclick', evtData);\n        if(dblClickVal !== false) handleClick(legendItem, gd, numClicks);\n    }\n}\n\nfunction drawTexts(g, gd, opts) {\n    var legendItem = g.data()[0][0];\n    var trace = legendItem.trace;\n    var isPieLike = Registry.traceIs(trace, 'pie-like');\n    var traceIndex = trace.index;\n    var isEditable = opts._main && gd._context.edits.legendText && !isPieLike;\n    var maxNameLength = opts._maxNameLength;\n\n    var name;\n    if(!opts.entries) {\n        name = isPieLike ? legendItem.label : trace.name;\n        if(trace._meta) {\n            name = Lib.templateString(name, trace._meta);\n        }\n    } else {\n        name = legendItem.text;\n    }\n\n    var textEl = Lib.ensureSingle(g, 'text', 'legendtext');\n\n    textEl.attr('text-anchor', 'start')\n        .call(Drawing.font, opts.font)\n        .text(isEditable ? ensureLength(name, maxNameLength) : name);\n\n    var textGap = opts.itemwidth + constants.itemGap * 2;\n    svgTextUtils.positionText(textEl, textGap, 0);\n\n    if(isEditable) {\n        textEl.call(svgTextUtils.makeEditable, {gd: gd, text: name})\n            .call(textLayout, g, gd, opts)\n            .on('edit', function(newName) {\n                this.text(ensureLength(newName, maxNameLength))\n                    .call(textLayout, g, gd, opts);\n\n                var fullInput = legendItem.trace._fullInput || {};\n                var update = {};\n\n                if(Registry.hasTransform(fullInput, 'groupby')) {\n                    var groupbyIndices = Registry.getTransformIndices(fullInput, 'groupby');\n                    var index = groupbyIndices[groupbyIndices.length - 1];\n\n                    var kcont = Lib.keyedContainer(fullInput, 'transforms[' + index + '].styles', 'target', 'value.name');\n\n                    kcont.set(legendItem.trace._group, newName);\n\n                    update = kcont.constructUpdate();\n                } else {\n                    update.name = newName;\n                }\n\n                return Registry.call('_guiRestyle', gd, update, traceIndex);\n            });\n    } else {\n        textLayout(textEl, g, gd, opts);\n    }\n}\n\n/*\n * Make sure we have a reasonably clickable region.\n * If this string is missing or very short, pad it with spaces out to at least\n * 4 characters, up to the max length of other labels, on the assumption that\n * most characters are wider than spaces so a string of spaces will usually be\n * no wider than the real labels.\n */\nfunction ensureLength(str, maxLength) {\n    var targetLength = Math.max(4, maxLength);\n    if(str && str.trim().length >= targetLength / 2) return str;\n    str = str || '';\n    for(var i = targetLength - str.length; i > 0; i--) str += ' ';\n    return str;\n}\n\nfunction setupTraceToggle(g, gd) {\n    var doubleClickDelay = gd._context.doubleClickDelay;\n    var newMouseDownTime;\n    var numClicks = 1;\n\n    var traceToggle = Lib.ensureSingle(g, 'rect', 'legendtoggle', function(s) {\n        if(!gd._context.staticPlot) {\n            s.style('cursor', 'pointer').attr('pointer-events', 'all');\n        }\n        s.call(Color.fill, 'rgba(0,0,0,0)');\n    });\n\n    if(gd._context.staticPlot) return;\n\n    traceToggle.on('mousedown', function() {\n        newMouseDownTime = (new Date()).getTime();\n        if(newMouseDownTime - gd._legendMouseDownTime < doubleClickDelay) {\n            // in a click train\n            numClicks += 1;\n        } else {\n            // new click train\n            numClicks = 1;\n            gd._legendMouseDownTime = newMouseDownTime;\n        }\n    });\n    traceToggle.on('mouseup', function() {\n        if(gd._dragged || gd._editing) return;\n        var legend = gd._fullLayout.legend;\n\n        if((new Date()).getTime() - gd._legendMouseDownTime > doubleClickDelay) {\n            numClicks = Math.max(numClicks - 1, 1);\n        }\n\n        clickOrDoubleClick(gd, legend, g, numClicks, d3.event);\n    });\n}\n\nfunction textLayout(s, g, gd, opts) {\n    if(!opts._main) s.attr('data-notex', true); // do not process MathJax if not main\n    svgTextUtils.convertToTspans(s, gd, function() {\n        computeTextDimensions(g, gd, opts);\n    });\n}\n\nfunction computeTextDimensions(g, gd, opts) {\n    var legendItem = g.data()[0][0];\n    if(opts._main && legendItem && !legendItem.trace.showlegend) {\n        g.remove();\n        return;\n    }\n\n    var mathjaxGroup = g.select('g[class*=math-group]');\n    var mathjaxNode = mathjaxGroup.node();\n    if(!opts) opts = gd._fullLayout.legend;\n    var bw = opts.borderwidth;\n    var lineHeight = (legendItem ? opts : opts.title).font.size * LINE_SPACING;\n    var height, width;\n\n    if(mathjaxNode) {\n        var mathjaxBB = Drawing.bBox(mathjaxNode);\n\n        height = mathjaxBB.height;\n        width = mathjaxBB.width;\n\n        if(legendItem) {\n            Drawing.setTranslate(mathjaxGroup, 0, height * 0.25);\n        } else { // case of title\n            Drawing.setTranslate(mathjaxGroup, bw, height * 0.75 + bw);\n        }\n    } else {\n        var textEl = g.select(legendItem ?\n            '.legendtext' : '.legendtitletext'\n        );\n        var textLines = svgTextUtils.lineCount(textEl);\n        var textNode = textEl.node();\n\n        height = lineHeight * textLines;\n        width = textNode ? Drawing.bBox(textNode).width : 0;\n\n        // approximation to height offset to center the font\n        // to avoid getBoundingClientRect\n        var textY = lineHeight * ((textLines - 1) / 2 - 0.3);\n        if(legendItem) {\n            var textGap = opts.itemwidth + constants.itemGap * 2;\n            svgTextUtils.positionText(textEl, textGap, -textY);\n        } else { // case of title\n            svgTextUtils.positionText(textEl, constants.titlePad + bw, lineHeight + bw);\n        }\n    }\n\n    if(legendItem) {\n        legendItem.lineHeight = lineHeight;\n        legendItem.height = Math.max(height, 16) + 3;\n        legendItem.width = width;\n    } else { // case of title\n        opts._titleWidth = width;\n        opts._titleHeight = height;\n    }\n}\n\nfunction getTitleSize(opts) {\n    var w = 0;\n    var h = 0;\n\n    var side = opts.title.side;\n    if(side) {\n        if(side.indexOf('left') !== -1) {\n            w = opts._titleWidth;\n        }\n        if(side.indexOf('top') !== -1) {\n            h = opts._titleHeight;\n        }\n    }\n\n    return [w, h];\n}\n\n/*\n * Computes in fullLayout.legend:\n *\n *  - _height: legend height including items past scrollbox height\n *  - _maxHeight: maximum legend height before scrollbox is required\n *  - _effHeight: legend height w/ or w/o scrollbox\n *\n *  - _width: legend width\n *  - _maxWidth (for orientation:h only): maximum width before starting new row\n */\nfunction computeLegendDimensions(gd, groups, traces, opts) {\n    var fullLayout = gd._fullLayout;\n    if(!opts) opts = fullLayout.legend;\n    var gs = fullLayout._size;\n\n    var isVertical = helpers.isVertical(opts);\n    var isGrouped = helpers.isGrouped(opts);\n\n    var bw = opts.borderwidth;\n    var bw2 = 2 * bw;\n    var itemGap = constants.itemGap;\n    var textGap = opts.itemwidth + itemGap * 2;\n    var endPad = 2 * (bw + itemGap);\n\n    var yanchor = getYanchor(opts);\n    var isBelowPlotArea = opts.y < 0 || (opts.y === 0 && yanchor === 'top');\n    var isAbovePlotArea = opts.y > 1 || (opts.y === 1 && yanchor === 'bottom');\n\n    // - if below/above plot area, give it the maximum potential margin-push value\n    // - otherwise, extend the height of the plot area\n    opts._maxHeight = Math.max(\n        (isBelowPlotArea || isAbovePlotArea) ? fullLayout.height / 2 : gs.h,\n        30\n    );\n\n    var toggleRectWidth = 0;\n    opts._width = 0;\n    opts._height = 0;\n    var titleSize = getTitleSize(opts);\n\n    if(isVertical) {\n        traces.each(function(d) {\n            var h = d[0].height;\n            Drawing.setTranslate(this,\n                bw + titleSize[0],\n                bw + titleSize[1] + opts._height + h / 2 + itemGap\n            );\n            opts._height += h;\n            opts._width = Math.max(opts._width, d[0].width);\n        });\n\n        toggleRectWidth = textGap + opts._width;\n        opts._width += itemGap + textGap + bw2;\n        opts._height += endPad;\n\n        if(isGrouped) {\n            groups.each(function(d, i) {\n                Drawing.setTranslate(this, 0, i * opts.tracegroupgap);\n            });\n            opts._height += (opts._lgroupsLength - 1) * opts.tracegroupgap;\n        }\n    } else {\n        var xanchor = getXanchor(opts);\n        var isLeftOfPlotArea = opts.x < 0 || (opts.x === 0 && xanchor === 'right');\n        var isRightOfPlotArea = opts.x > 1 || (opts.x === 1 && xanchor === 'left');\n        var isBeyondPlotAreaY = isAbovePlotArea || isBelowPlotArea;\n        var hw = fullLayout.width / 2;\n\n        // - if placed within x-margins, extend the width of the plot area\n        // - else if below/above plot area and anchored in the margin, extend to opposite margin,\n        // - otherwise give it the maximum potential margin-push value\n        opts._maxWidth = Math.max(\n            isLeftOfPlotArea ? ((isBeyondPlotAreaY && xanchor === 'left') ? gs.l + gs.w : hw) :\n            isRightOfPlotArea ? ((isBeyondPlotAreaY && xanchor === 'right') ? gs.r + gs.w : hw) :\n            gs.w,\n        2 * textGap);\n        var maxItemWidth = 0;\n        var combinedItemWidth = 0;\n        traces.each(function(d) {\n            var w = d[0].width + textGap;\n            maxItemWidth = Math.max(maxItemWidth, w);\n            combinedItemWidth += w;\n        });\n\n        toggleRectWidth = null;\n        var maxRowWidth = 0;\n\n        if(isGrouped) {\n            var maxGroupHeightInRow = 0;\n            var groupOffsetX = 0;\n            var groupOffsetY = 0;\n            groups.each(function() {\n                var maxWidthInGroup = 0;\n                var offsetY = 0;\n                d3.select(this).selectAll('g.traces').each(function(d) {\n                    var h = d[0].height;\n                    Drawing.setTranslate(this,\n                        titleSize[0],\n                        titleSize[1] + bw + itemGap + h / 2 + offsetY\n                    );\n                    offsetY += h;\n                    maxWidthInGroup = Math.max(maxWidthInGroup, textGap + d[0].width);\n                });\n                maxGroupHeightInRow = Math.max(maxGroupHeightInRow, offsetY);\n\n                var next = maxWidthInGroup + itemGap;\n\n                if((next + bw + groupOffsetX) > opts._maxWidth) {\n                    maxRowWidth = Math.max(maxRowWidth, groupOffsetX);\n                    groupOffsetX = 0;\n                    groupOffsetY += maxGroupHeightInRow + opts.tracegroupgap;\n                    maxGroupHeightInRow = offsetY;\n                }\n\n                Drawing.setTranslate(this, groupOffsetX, groupOffsetY);\n\n                groupOffsetX += next;\n            });\n\n            opts._width = Math.max(maxRowWidth, groupOffsetX) + bw;\n            opts._height = groupOffsetY + maxGroupHeightInRow + endPad;\n        } else {\n            var nTraces = traces.size();\n            var oneRowLegend = (combinedItemWidth + bw2 + (nTraces - 1) * itemGap) < opts._maxWidth;\n\n            var maxItemHeightInRow = 0;\n            var offsetX = 0;\n            var offsetY = 0;\n            var rowWidth = 0;\n            traces.each(function(d) {\n                var h = d[0].height;\n                var w = textGap + d[0].width;\n                var next = (oneRowLegend ? w : maxItemWidth) + itemGap;\n\n                if((next + bw + offsetX - itemGap) >= opts._maxWidth) {\n                    maxRowWidth = Math.max(maxRowWidth, rowWidth);\n                    offsetX = 0;\n                    offsetY += maxItemHeightInRow;\n                    opts._height += maxItemHeightInRow;\n                    maxItemHeightInRow = 0;\n                }\n\n                Drawing.setTranslate(this,\n                    titleSize[0] + bw + offsetX,\n                    titleSize[1] + bw + offsetY + h / 2 + itemGap\n                );\n\n                rowWidth = offsetX + w + itemGap;\n                offsetX += next;\n                maxItemHeightInRow = Math.max(maxItemHeightInRow, h);\n            });\n\n            if(oneRowLegend) {\n                opts._width = offsetX + bw2;\n                opts._height = maxItemHeightInRow + endPad;\n            } else {\n                opts._width = Math.max(maxRowWidth, rowWidth) + bw2;\n                opts._height += maxItemHeightInRow + endPad;\n            }\n        }\n    }\n\n    opts._width = Math.ceil(\n        Math.max(\n            opts._width + titleSize[0],\n            opts._titleWidth + 2 * (bw + constants.titlePad)\n        )\n    );\n\n    opts._height = Math.ceil(\n        Math.max(\n            opts._height + titleSize[1],\n            opts._titleHeight + 2 * (bw + constants.itemGap)\n        )\n    );\n\n    opts._effHeight = Math.min(opts._height, opts._maxHeight);\n\n    var edits = gd._context.edits;\n    var isEditable = edits.legendText || edits.legendPosition;\n    traces.each(function(d) {\n        var traceToggle = d3.select(this).select('.legendtoggle');\n        var h = d[0].height;\n        var w = isEditable ? textGap : (toggleRectWidth || (textGap + d[0].width));\n        if(!isVertical) w += itemGap / 2;\n        Drawing.setRect(traceToggle, 0, -h / 2, w, h);\n    });\n}\n\nfunction expandMargin(gd) {\n    var fullLayout = gd._fullLayout;\n    var opts = fullLayout.legend;\n    var xanchor = getXanchor(opts);\n    var yanchor = getYanchor(opts);\n\n    return Plots.autoMargin(gd, 'legend', {\n        x: opts.x,\n        y: opts.y,\n        l: opts._width * (FROM_TL[xanchor]),\n        r: opts._width * (FROM_BR[xanchor]),\n        b: opts._effHeight * (FROM_BR[yanchor]),\n        t: opts._effHeight * (FROM_TL[yanchor])\n    });\n}\n\nfunction getXanchor(opts) {\n    return Lib.isRightAnchor(opts) ? 'right' :\n        Lib.isCenterAnchor(opts) ? 'center' :\n        'left';\n}\n\nfunction getYanchor(opts) {\n    return Lib.isBottomAnchor(opts) ? 'bottom' :\n        Lib.isMiddleAnchor(opts) ? 'middle' :\n        'top';\n}\n"]},"metadata":{},"sourceType":"script"}