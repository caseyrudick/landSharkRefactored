{"ast":null,"code":"'use strict';\n\nmodule.exports = gradient;\n\nvar dup = require('dup');\n\nvar cwiseCompiler = require('cwise-compiler');\n\nvar TEMPLATE_CACHE = {};\nvar GRADIENT_CACHE = {};\nvar EmptyProc = {\n  body: \"\",\n  args: [],\n  thisVars: [],\n  localVars: []\n};\nvar centralDiff = cwiseCompiler({\n  args: ['array', 'array', 'array'],\n  pre: EmptyProc,\n  post: EmptyProc,\n  body: {\n    args: [{\n      name: 'out',\n      lvalue: true,\n      rvalue: false,\n      count: 1\n    }, {\n      name: 'left',\n      lvalue: false,\n      rvalue: true,\n      count: 1\n    }, {\n      name: 'right',\n      lvalue: false,\n      rvalue: true,\n      count: 1\n    }],\n    body: \"out=0.5*(left-right)\",\n    thisVars: [],\n    localVars: []\n  },\n  funcName: 'cdiff'\n});\nvar zeroOut = cwiseCompiler({\n  args: ['array'],\n  pre: EmptyProc,\n  post: EmptyProc,\n  body: {\n    args: [{\n      name: 'out',\n      lvalue: true,\n      rvalue: false,\n      count: 1\n    }],\n    body: \"out=0\",\n    thisVars: [],\n    localVars: []\n  },\n  funcName: 'zero'\n});\n\nfunction generateTemplate(d) {\n  if (d in TEMPLATE_CACHE) {\n    return TEMPLATE_CACHE[d];\n  }\n\n  var code = [];\n\n  for (var i = 0; i < d; ++i) {\n    code.push('out', i, 's=0.5*(inp', i, 'l-inp', i, 'r);');\n  }\n\n  var args = ['array'];\n  var names = ['junk'];\n\n  for (var i = 0; i < d; ++i) {\n    args.push('array');\n    names.push('out' + i + 's');\n    var o = dup(d);\n    o[i] = -1;\n    args.push({\n      array: 0,\n      offset: o.slice()\n    });\n    o[i] = 1;\n    args.push({\n      array: 0,\n      offset: o.slice()\n    });\n    names.push('inp' + i + 'l', 'inp' + i + 'r');\n  }\n\n  return TEMPLATE_CACHE[d] = cwiseCompiler({\n    args: args,\n    pre: EmptyProc,\n    post: EmptyProc,\n    body: {\n      body: code.join(''),\n      args: names.map(function (n) {\n        return {\n          name: n,\n          lvalue: n.indexOf('out') === 0,\n          rvalue: n.indexOf('inp') === 0,\n          count: n !== 'junk' | 0\n        };\n      }),\n      thisVars: [],\n      localVars: []\n    },\n    funcName: 'fdTemplate' + d\n  });\n}\n\nfunction generateGradient(boundaryConditions) {\n  var token = boundaryConditions.join();\n  var proc = GRADIENT_CACHE[token];\n\n  if (proc) {\n    return proc;\n  }\n\n  var d = boundaryConditions.length;\n  var code = ['function gradient(dst,src){var s=src.shape.slice();'];\n\n  function handleBoundary(facet) {\n    var cod = d - facet.length;\n    var loStr = [];\n    var hiStr = [];\n    var pickStr = [];\n\n    for (var i = 0; i < d; ++i) {\n      if (facet.indexOf(i + 1) >= 0) {\n        pickStr.push('0');\n      } else if (facet.indexOf(-(i + 1)) >= 0) {\n        pickStr.push('s[' + i + ']-1');\n      } else {\n        pickStr.push('-1');\n        loStr.push('1');\n        hiStr.push('s[' + i + ']-2');\n      }\n    }\n\n    var boundStr = '.lo(' + loStr.join() + ').hi(' + hiStr.join() + ')';\n\n    if (loStr.length === 0) {\n      boundStr = '';\n    }\n\n    if (cod > 0) {\n      code.push('if(1');\n\n      for (var i = 0; i < d; ++i) {\n        if (facet.indexOf(i + 1) >= 0 || facet.indexOf(-(i + 1)) >= 0) {\n          continue;\n        }\n\n        code.push('&&s[', i, ']>2');\n      }\n\n      code.push('){grad', cod, '(src.pick(', pickStr.join(), ')', boundStr);\n\n      for (var i = 0; i < d; ++i) {\n        if (facet.indexOf(i + 1) >= 0 || facet.indexOf(-(i + 1)) >= 0) {\n          continue;\n        }\n\n        code.push(',dst.pick(', pickStr.join(), ',', i, ')', boundStr);\n      }\n\n      code.push(');');\n    }\n\n    for (var i = 0; i < facet.length; ++i) {\n      var bnd = Math.abs(facet[i]) - 1;\n      var outStr = 'dst.pick(' + pickStr.join() + ',' + bnd + ')' + boundStr;\n\n      switch (boundaryConditions[bnd]) {\n        case 'clamp':\n          var cPickStr = pickStr.slice();\n          var dPickStr = pickStr.slice();\n\n          if (facet[i] < 0) {\n            cPickStr[bnd] = 's[' + bnd + ']-2';\n          } else {\n            dPickStr[bnd] = '1';\n          }\n\n          if (cod === 0) {\n            code.push('if(s[', bnd, ']>1){dst.set(', pickStr.join(), ',', bnd, ',0.5*(src.get(', cPickStr.join(), ')-src.get(', dPickStr.join(), ')))}else{dst.set(', pickStr.join(), ',', bnd, ',0)};');\n          } else {\n            code.push('if(s[', bnd, ']>1){diff(', outStr, ',src.pick(', cPickStr.join(), ')', boundStr, ',src.pick(', dPickStr.join(), ')', boundStr, ');}else{zero(', outStr, ');};');\n          }\n\n          break;\n\n        case 'mirror':\n          if (cod === 0) {\n            code.push('dst.set(', pickStr.join(), ',', bnd, ',0);');\n          } else {\n            code.push('zero(', outStr, ');');\n          }\n\n          break;\n\n        case 'wrap':\n          var aPickStr = pickStr.slice();\n          var bPickStr = pickStr.slice();\n\n          if (facet[i] < 0) {\n            aPickStr[bnd] = 's[' + bnd + ']-2';\n            bPickStr[bnd] = '0';\n          } else {\n            aPickStr[bnd] = 's[' + bnd + ']-1';\n            bPickStr[bnd] = '1';\n          }\n\n          if (cod === 0) {\n            code.push('if(s[', bnd, ']>2){dst.set(', pickStr.join(), ',', bnd, ',0.5*(src.get(', aPickStr.join(), ')-src.get(', bPickStr.join(), ')))}else{dst.set(', pickStr.join(), ',', bnd, ',0)};');\n          } else {\n            code.push('if(s[', bnd, ']>2){diff(', outStr, ',src.pick(', aPickStr.join(), ')', boundStr, ',src.pick(', bPickStr.join(), ')', boundStr, ');}else{zero(', outStr, ');};');\n          }\n\n          break;\n\n        default:\n          throw new Error('ndarray-gradient: Invalid boundary condition');\n      }\n    }\n\n    if (cod > 0) {\n      code.push('};');\n    }\n  } //Enumerate ridges, facets, etc. of hypercube\n\n\n  for (var i = 0; i < 1 << d; ++i) {\n    var faces = [];\n\n    for (var j = 0; j < d; ++j) {\n      if (i & 1 << j) {\n        faces.push(j + 1);\n      }\n    }\n\n    for (var k = 0; k < 1 << faces.length; ++k) {\n      var sfaces = faces.slice();\n\n      for (var j = 0; j < faces.length; ++j) {\n        if (k & 1 << j) {\n          sfaces[j] = -sfaces[j];\n        }\n      }\n\n      handleBoundary(sfaces);\n    }\n  }\n\n  code.push('return dst;};return gradient'); //Compile and link routine, save cached procedure\n\n  var linkNames = ['diff', 'zero'];\n  var linkArgs = [centralDiff, zeroOut];\n\n  for (var i = 1; i <= d; ++i) {\n    linkNames.push('grad' + i);\n    linkArgs.push(generateTemplate(i));\n  }\n\n  linkNames.push(code.join(''));\n  var link = Function.apply(void 0, linkNames);\n  var proc = link.apply(void 0, linkArgs);\n  TEMPLATE_CACHE[token] = proc;\n  return proc;\n}\n\nfunction gradient(out, inp, bc) {\n  if (Array.isArray(bc)) {\n    if (bc.length !== inp.dimension) {\n      throw new Error('ndarray-gradient: invalid boundary conditions');\n    }\n  } else if (typeof bc === 'string') {\n    bc = dup(inp.dimension, bc);\n  } else {\n    bc = dup(inp.dimension, 'clamp');\n  }\n\n  if (out.dimension !== inp.dimension + 1) {\n    throw new Error('ndarray-gradient: output dimension must be +1 input dimension');\n  }\n\n  if (out.shape[inp.dimension] !== inp.dimension) {\n    throw new Error('ndarray-gradient: output shape must match input shape');\n  }\n\n  for (var i = 0; i < inp.dimension; ++i) {\n    if (out.shape[i] !== inp.shape[i]) {\n      throw new Error('ndarray-gradient: shape mismatch');\n    }\n  }\n\n  if (inp.size === 0) {\n    return out;\n  }\n\n  if (inp.dimension <= 0) {\n    out.set(0);\n    return out;\n  }\n\n  var cached = generateGradient(bc);\n  return cached(out, inp);\n}","map":{"version":3,"sources":["/Users/caseyrudick/Documents/landsharkrefactored-copy/client/node_modules/ndarray-gradient/fdg.js"],"names":["module","exports","gradient","dup","require","cwiseCompiler","TEMPLATE_CACHE","GRADIENT_CACHE","EmptyProc","body","args","thisVars","localVars","centralDiff","pre","post","name","lvalue","rvalue","count","funcName","zeroOut","generateTemplate","d","code","i","push","names","o","array","offset","slice","join","map","n","indexOf","generateGradient","boundaryConditions","token","proc","length","handleBoundary","facet","cod","loStr","hiStr","pickStr","boundStr","bnd","Math","abs","outStr","cPickStr","dPickStr","aPickStr","bPickStr","Error","faces","j","k","sfaces","linkNames","linkArgs","link","Function","apply","out","inp","bc","Array","isArray","dimension","shape","size","set","cached"],"mappings":"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","sourcesContent":["'use strict'\n\nmodule.exports      = gradient\n\nvar dup             = require('dup')\nvar cwiseCompiler   = require('cwise-compiler')\n\nvar TEMPLATE_CACHE  = {}\nvar GRADIENT_CACHE  = {}\n\nvar EmptyProc = {\n  body: \"\",\n  args: [],\n  thisVars: [],\n  localVars: []\n}\n\nvar centralDiff = cwiseCompiler({\n  args: [ 'array', 'array', 'array' ],\n  pre: EmptyProc,\n  post: EmptyProc,\n  body: {\n    args: [ {\n      name: 'out', \n      lvalue: true,\n      rvalue: false,\n      count: 1\n    }, {\n      name: 'left', \n      lvalue: false,\n      rvalue: true,\n      count: 1\n    }, {\n      name: 'right', \n      lvalue: false,\n      rvalue: true,\n      count: 1\n    }],\n    body: \"out=0.5*(left-right)\",\n    thisVars: [],\n    localVars: []\n  },\n  funcName: 'cdiff'\n})\n\nvar zeroOut = cwiseCompiler({\n  args: [ 'array' ],\n  pre: EmptyProc,\n  post: EmptyProc,\n  body: {\n    args: [ {\n      name: 'out', \n      lvalue: true,\n      rvalue: false,\n      count: 1\n    }],\n    body: \"out=0\",\n    thisVars: [],\n    localVars: []\n  },\n  funcName: 'zero'\n})\n\nfunction generateTemplate(d) {\n  if(d in TEMPLATE_CACHE) {\n    return TEMPLATE_CACHE[d]\n  }\n  var code = []\n  for(var i=0; i<d; ++i) {\n    code.push('out', i, 's=0.5*(inp', i, 'l-inp', i, 'r);')\n  }\n  var args = [ 'array' ]\n  var names = ['junk']\n  for(var i=0; i<d; ++i) {\n    args.push('array')\n    names.push('out' + i + 's')\n    var o = dup(d)\n    o[i] = -1\n    args.push({\n      array: 0,\n      offset: o.slice()\n    })\n    o[i] = 1\n    args.push({\n      array: 0,\n      offset: o.slice()\n    })\n    names.push('inp' + i + 'l', 'inp' + i + 'r')\n  }\n  return TEMPLATE_CACHE[d] = cwiseCompiler({\n    args: args,\n    pre:  EmptyProc,\n    post: EmptyProc,\n    body: {\n      body: code.join(''),\n      args: names.map(function(n) {\n        return {\n          name: n,\n          lvalue: n.indexOf('out') === 0,\n          rvalue: n.indexOf('inp') === 0,\n          count: (n!=='junk')|0\n        }\n      }),\n      thisVars: [],\n      localVars: []\n    },\n    funcName: 'fdTemplate' + d\n  })\n}\n\nfunction generateGradient(boundaryConditions) {\n  var token = boundaryConditions.join()\n  var proc = GRADIENT_CACHE[token]\n  if(proc) {\n    return proc\n  }\n\n  var d = boundaryConditions.length\n  var code = ['function gradient(dst,src){var s=src.shape.slice();' ]\n  \n  function handleBoundary(facet) {\n    var cod = d - facet.length\n\n    var loStr = []\n    var hiStr = []\n    var pickStr = []\n    for(var i=0; i<d; ++i) {\n      if(facet.indexOf(i+1) >= 0) {\n        pickStr.push('0')\n      } else if(facet.indexOf(-(i+1)) >= 0) {\n        pickStr.push('s['+i+']-1')\n      } else {\n        pickStr.push('-1')\n        loStr.push('1')\n        hiStr.push('s['+i+']-2')\n      }\n    }\n    var boundStr = '.lo(' + loStr.join() + ').hi(' + hiStr.join() + ')'\n    if(loStr.length === 0) {\n      boundStr = ''\n    }\n        \n    if(cod > 0) {\n      code.push('if(1') \n      for(var i=0; i<d; ++i) {\n        if(facet.indexOf(i+1) >= 0 || facet.indexOf(-(i+1)) >= 0) {\n          continue\n        }\n        code.push('&&s[', i, ']>2')\n      }\n      code.push('){grad', cod, '(src.pick(', pickStr.join(), ')', boundStr)\n      for(var i=0; i<d; ++i) {\n        if(facet.indexOf(i+1) >= 0 || facet.indexOf(-(i+1)) >= 0) {\n          continue\n        }\n        code.push(',dst.pick(', pickStr.join(), ',', i, ')', boundStr)\n      }\n      code.push(');')\n    }\n\n    for(var i=0; i<facet.length; ++i) {\n      var bnd = Math.abs(facet[i])-1\n      var outStr = 'dst.pick(' + pickStr.join() + ',' + bnd + ')' + boundStr\n      switch(boundaryConditions[bnd]) {\n\n        case 'clamp':\n          var cPickStr = pickStr.slice()\n          var dPickStr = pickStr.slice()\n          if(facet[i] < 0) {\n            cPickStr[bnd] = 's[' + bnd + ']-2'\n          } else {\n            dPickStr[bnd] = '1'\n          }\n          if(cod === 0) {\n            code.push('if(s[', bnd, ']>1){dst.set(',\n              pickStr.join(), ',', bnd, ',0.5*(src.get(',\n                cPickStr.join(), ')-src.get(',\n                dPickStr.join(), ')))}else{dst.set(',\n              pickStr.join(), ',', bnd, ',0)};')\n          } else {\n            code.push('if(s[', bnd, ']>1){diff(', outStr, \n                ',src.pick(', cPickStr.join(), ')', boundStr, \n                ',src.pick(', dPickStr.join(), ')', boundStr, \n                ');}else{zero(', outStr, ');};')\n          }\n        break\n\n        case 'mirror':\n          if(cod === 0) {\n            code.push('dst.set(', pickStr.join(), ',', bnd, ',0);')\n          } else {\n            code.push('zero(', outStr, ');')\n          }\n        break\n\n        case 'wrap':\n          var aPickStr = pickStr.slice()\n          var bPickStr = pickStr.slice()\n          if(facet[i] < 0) {\n            aPickStr[bnd] = 's[' + bnd + ']-2'\n            bPickStr[bnd] = '0'\n            \n          } else {\n            aPickStr[bnd] = 's[' + bnd + ']-1'\n            bPickStr[bnd] = '1'\n          }\n          if(cod === 0) {\n            code.push('if(s[', bnd, ']>2){dst.set(',\n              pickStr.join(), ',', bnd, ',0.5*(src.get(',\n                aPickStr.join(), ')-src.get(',\n                bPickStr.join(), ')))}else{dst.set(',\n              pickStr.join(), ',', bnd, ',0)};')\n          } else {\n            code.push('if(s[', bnd, ']>2){diff(', outStr, \n                ',src.pick(', aPickStr.join(), ')', boundStr, \n                ',src.pick(', bPickStr.join(), ')', boundStr, \n                ');}else{zero(', outStr, ');};')\n          }\n        break\n\n        default:\n          throw new Error('ndarray-gradient: Invalid boundary condition')\n      }\n    }\n\n    if(cod > 0) {\n      code.push('};')\n    }\n  }\n\n  //Enumerate ridges, facets, etc. of hypercube\n  for(var i=0; i<(1<<d); ++i) {\n    var faces = []\n    for(var j=0; j<d; ++j) {\n      if(i & (1<<j)) {\n        faces.push(j+1)\n      }\n    }\n    for(var k=0; k<(1<<faces.length); ++k) {\n      var sfaces = faces.slice()\n      for(var j=0; j<faces.length; ++j) {\n        if(k & (1<<j)) {\n          sfaces[j] = -sfaces[j]\n        }\n      }\n      handleBoundary(sfaces)\n    }\n  }\n\n  code.push('return dst;};return gradient')\n\n  //Compile and link routine, save cached procedure\n  var linkNames = [ 'diff', 'zero' ]\n  var linkArgs  = [ centralDiff, zeroOut ]\n  for(var i=1; i<=d; ++i) {\n    linkNames.push('grad' + i)\n    linkArgs.push(generateTemplate(i))\n  }\n  linkNames.push(code.join(''))\n\n  var link = Function.apply(void 0, linkNames)\n  var proc = link.apply(void 0, linkArgs)\n  TEMPLATE_CACHE[token] = proc\n  return proc\n}\n\nfunction gradient(out, inp, bc) {\n  if(Array.isArray(bc)) {\n    if(bc.length !== inp.dimension) {\n      throw new Error('ndarray-gradient: invalid boundary conditions')\n    }\n  } else if(typeof bc === 'string') {\n    bc = dup(inp.dimension, bc)\n  } else {\n    bc = dup(inp.dimension, 'clamp')\n  }\n  if(out.dimension !== inp.dimension + 1) {\n    throw new Error('ndarray-gradient: output dimension must be +1 input dimension')\n  }\n  if(out.shape[inp.dimension] !== inp.dimension) {\n    throw new Error('ndarray-gradient: output shape must match input shape')\n  }\n  for(var i=0; i<inp.dimension; ++i) {\n    if(out.shape[i] !== inp.shape[i]) {\n      throw new Error('ndarray-gradient: shape mismatch')\n    }\n  }\n  if(inp.size === 0) {\n    return out\n  }\n  if(inp.dimension <= 0) {\n    out.set(0)\n    return out\n  }\n  var cached = generateGradient(bc)\n  return cached(out, inp)\n}"]},"metadata":{},"sourceType":"script"}