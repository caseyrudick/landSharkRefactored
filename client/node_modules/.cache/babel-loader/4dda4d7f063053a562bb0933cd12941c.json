{"ast":null,"code":"/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar c = require('./constants');\n\nvar d3 = require('d3');\n\nvar tinycolor = require('tinycolor2');\n\nvar Color = require('../../components/color');\n\nvar Drawing = require('../../components/drawing');\n\nvar d3Sankey = require('@plotly/d3-sankey');\n\nvar d3SankeyCircular = require('@plotly/d3-sankey-circular');\n\nvar d3Force = require('d3-force');\n\nvar Lib = require('../../lib');\n\nvar strTranslate = Lib.strTranslate;\n\nvar gup = require('../../lib/gup');\n\nvar keyFun = gup.keyFun;\nvar repeat = gup.repeat;\nvar unwrap = gup.unwrap;\n\nvar interpolateNumber = require('d3-interpolate').interpolateNumber;\n\nvar Registry = require('../../registry'); // view models\n\n\nfunction sankeyModel(layout, d, traceIndex) {\n  var calcData = unwrap(d);\n  var trace = calcData.trace;\n  var domain = trace.domain;\n  var horizontal = trace.orientation === 'h';\n  var nodePad = trace.node.pad;\n  var nodeThickness = trace.node.thickness;\n  var width = layout.width * (domain.x[1] - domain.x[0]);\n  var height = layout.height * (domain.y[1] - domain.y[0]);\n  var nodes = calcData._nodes;\n  var links = calcData._links;\n  var circular = calcData.circular; // Select Sankey generator\n\n  var sankey;\n\n  if (circular) {\n    sankey = d3SankeyCircular.sankeyCircular().circularLinkGap(0);\n  } else {\n    sankey = d3Sankey.sankey();\n  }\n\n  sankey.iterations(c.sankeyIterations).size(horizontal ? [width, height] : [height, width]).nodeWidth(nodeThickness).nodePadding(nodePad).nodeId(function (d) {\n    return d.pointNumber;\n  }).nodes(nodes).links(links);\n  var graph = sankey();\n\n  if (sankey.nodePadding() < nodePad) {\n    Lib.warn('node.pad was reduced to ', sankey.nodePadding(), ' to fit within the figure.');\n  } // Counters for nested loops\n\n\n  var i, j, k; // Create transient nodes for animations\n\n  for (var nodePointNumber in calcData._groupLookup) {\n    var groupIndex = parseInt(calcData._groupLookup[nodePointNumber]); // Find node representing groupIndex\n\n    var groupingNode;\n\n    for (i = 0; i < graph.nodes.length; i++) {\n      if (graph.nodes[i].pointNumber === groupIndex) {\n        groupingNode = graph.nodes[i];\n        break;\n      }\n    } // If groupinNode is undefined, no links are targeting this group\n\n\n    if (!groupingNode) continue;\n    var child = {\n      pointNumber: parseInt(nodePointNumber),\n      x0: groupingNode.x0,\n      x1: groupingNode.x1,\n      y0: groupingNode.y0,\n      y1: groupingNode.y1,\n      partOfGroup: true,\n      sourceLinks: [],\n      targetLinks: []\n    };\n    graph.nodes.unshift(child);\n    groupingNode.childrenNodes.unshift(child);\n  }\n\n  function computeLinkConcentrations() {\n    for (i = 0; i < graph.nodes.length; i++) {\n      var node = graph.nodes[i]; // Links connecting the same two nodes are part of a flow\n\n      var flows = {};\n      var flowKey;\n      var link;\n\n      for (j = 0; j < node.targetLinks.length; j++) {\n        link = node.targetLinks[j];\n        flowKey = link.source.pointNumber + ':' + link.target.pointNumber;\n        if (!flows.hasOwnProperty(flowKey)) flows[flowKey] = [];\n        flows[flowKey].push(link);\n      } // Compute statistics for each flow\n\n\n      var keys = Object.keys(flows);\n\n      for (j = 0; j < keys.length; j++) {\n        flowKey = keys[j];\n        var flowLinks = flows[flowKey]; // Find the total size of the flow and total size per label\n\n        var total = 0;\n        var totalPerLabel = {};\n\n        for (k = 0; k < flowLinks.length; k++) {\n          link = flowLinks[k];\n          if (!totalPerLabel[link.label]) totalPerLabel[link.label] = 0;\n          totalPerLabel[link.label] += link.value;\n          total += link.value;\n        } // Find the ratio of the link's value and the size of the flow\n\n\n        for (k = 0; k < flowLinks.length; k++) {\n          link = flowLinks[k];\n          link.flow = {\n            value: total,\n            labelConcentration: totalPerLabel[link.label] / total,\n            concentration: link.value / total,\n            links: flowLinks\n          };\n\n          if (link.concentrationscale) {\n            link.color = tinycolor(link.concentrationscale(link.flow.labelConcentration));\n          }\n        }\n      } // Gather statistics of all links at current node\n\n\n      var totalOutflow = 0;\n\n      for (j = 0; j < node.sourceLinks.length; j++) {\n        totalOutflow += node.sourceLinks[j].value;\n      }\n\n      for (j = 0; j < node.sourceLinks.length; j++) {\n        link = node.sourceLinks[j];\n        link.concentrationOut = link.value / totalOutflow;\n      }\n\n      var totalInflow = 0;\n\n      for (j = 0; j < node.targetLinks.length; j++) {\n        totalInflow += node.targetLinks[j].value;\n      }\n\n      for (j = 0; j < node.targetLinks.length; j++) {\n        link = node.targetLinks[j];\n        link.concenrationIn = link.value / totalInflow;\n      }\n    }\n  }\n\n  computeLinkConcentrations(); // Push any overlapping nodes down.\n\n  function resolveCollisionsTopToBottom(columns) {\n    columns.forEach(function (nodes) {\n      var node;\n      var dy;\n      var y = 0;\n      var n = nodes.length;\n      var i;\n      nodes.sort(function (a, b) {\n        return a.y0 - b.y0;\n      });\n\n      for (i = 0; i < n; ++i) {\n        node = nodes[i];\n\n        if (node.y0 >= y) {// No overlap\n        } else {\n          dy = y - node.y0;\n          if (dy > 1e-6) node.y0 += dy, node.y1 += dy;\n        }\n\n        y = node.y1 + nodePad;\n      }\n    });\n  } // Group nodes into columns based on their x position\n\n\n  function snapToColumns(nodes) {\n    // Sort nodes by x position\n    var orderedNodes = nodes.map(function (n, i) {\n      return {\n        x0: n.x0,\n        index: i\n      };\n    }).sort(function (a, b) {\n      return a.x0 - b.x0;\n    });\n    var columns = [];\n    var colNumber = -1;\n    var colX; // Position of column\n\n    var lastX = -Infinity; // Position of last node\n\n    var dx;\n\n    for (i = 0; i < orderedNodes.length; i++) {\n      var node = nodes[orderedNodes[i].index]; // If the node does not overlap with the last one\n\n      if (node.x0 > lastX + nodeThickness) {\n        // Start a new column\n        colNumber += 1;\n        colX = node.x0;\n      }\n\n      lastX = node.x0; // Add node to its associated column\n\n      if (!columns[colNumber]) columns[colNumber] = [];\n      columns[colNumber].push(node); // Change node's x position to align it with its column\n\n      dx = colX - node.x0;\n      node.x0 += dx, node.x1 += dx;\n    }\n\n    return columns;\n  } // Force node position\n\n\n  if (trace.node.x.length && trace.node.y.length) {\n    for (i = 0; i < Math.min(trace.node.x.length, trace.node.y.length, graph.nodes.length); i++) {\n      if (trace.node.x[i] && trace.node.y[i]) {\n        var pos = [trace.node.x[i] * width, trace.node.y[i] * height];\n        graph.nodes[i].x0 = pos[0] - nodeThickness / 2;\n        graph.nodes[i].x1 = pos[0] + nodeThickness / 2;\n        var nodeHeight = graph.nodes[i].y1 - graph.nodes[i].y0;\n        graph.nodes[i].y0 = pos[1] - nodeHeight / 2;\n        graph.nodes[i].y1 = pos[1] + nodeHeight / 2;\n      }\n    }\n\n    if (trace.arrangement === 'snap') {\n      nodes = graph.nodes;\n      var columns = snapToColumns(nodes);\n      resolveCollisionsTopToBottom(columns);\n    } // Update links\n\n\n    sankey.update(graph);\n  }\n\n  return {\n    circular: circular,\n    key: traceIndex,\n    trace: trace,\n    guid: Lib.randstr(),\n    horizontal: horizontal,\n    width: width,\n    height: height,\n    nodePad: trace.node.pad,\n    nodeLineColor: trace.node.line.color,\n    nodeLineWidth: trace.node.line.width,\n    linkLineColor: trace.link.line.color,\n    linkLineWidth: trace.link.line.width,\n    valueFormat: trace.valueformat,\n    valueSuffix: trace.valuesuffix,\n    textFont: trace.textfont,\n    translateX: domain.x[0] * layout.width + layout.margin.l,\n    translateY: layout.height - domain.y[1] * layout.height + layout.margin.t,\n    dragParallel: horizontal ? height : width,\n    dragPerpendicular: horizontal ? width : height,\n    arrangement: trace.arrangement,\n    sankey: sankey,\n    graph: graph,\n    forceLayouts: {},\n    interactionState: {\n      dragInProgress: false,\n      hovered: false\n    }\n  };\n}\n\nfunction linkModel(d, l, i) {\n  var tc = tinycolor(l.color);\n  var basicKey = l.source.label + '|' + l.target.label;\n  var key = basicKey + '__' + i; // for event data\n\n  l.trace = d.trace;\n  l.curveNumber = d.trace.index;\n  return {\n    circular: d.circular,\n    key: key,\n    traceId: d.key,\n    pointNumber: l.pointNumber,\n    link: l,\n    tinyColorHue: Color.tinyRGB(tc),\n    tinyColorAlpha: tc.getAlpha(),\n    linkPath: linkPath,\n    linkLineColor: d.linkLineColor,\n    linkLineWidth: d.linkLineWidth,\n    valueFormat: d.valueFormat,\n    valueSuffix: d.valueSuffix,\n    sankey: d.sankey,\n    parent: d,\n    interactionState: d.interactionState,\n    flow: l.flow\n  };\n}\n\nfunction createCircularClosedPathString(link) {\n  // Using coordinates computed by d3-sankey-circular\n  var pathString = '';\n  var offset = link.width / 2;\n  var coords = link.circularPathData;\n\n  if (link.circularLinkType === 'top') {\n    // Top path\n    pathString = // start at the left of the target node\n    'M ' + coords.targetX + ' ' + (coords.targetY + offset) + ' ' + 'L' + coords.rightInnerExtent + ' ' + (coords.targetY + offset) + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 1 ' + (coords.rightFullExtent - offset) + ' ' + (coords.targetY - coords.rightSmallArcRadius) + 'L' + (coords.rightFullExtent - offset) + ' ' + coords.verticalRightInnerExtent + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 1 ' + coords.rightInnerExtent + ' ' + (coords.verticalFullExtent - offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 1 ' + (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent + 'L' + (coords.leftFullExtent + offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 1 ' + coords.leftInnerExtent + ' ' + (coords.sourceY + offset) + 'L' + coords.sourceX + ' ' + (coords.sourceY + offset) + // Walking back\n    'L' + coords.sourceX + ' ' + (coords.sourceY - offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.sourceY - offset) + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 0 ' + (coords.leftFullExtent - offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) + 'L' + (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 0 ' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) + 'L' + coords.rightInnerExtent + ' ' + (coords.verticalFullExtent + offset) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 0 ' + (coords.rightFullExtent + offset) + ' ' + coords.verticalRightInnerExtent + 'L' + (coords.rightFullExtent + offset) + ' ' + (coords.targetY - coords.rightSmallArcRadius) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 0 ' + coords.rightInnerExtent + ' ' + (coords.targetY - offset) + 'L' + coords.targetX + ' ' + (coords.targetY - offset) + 'Z';\n  } else {\n    // Bottom path\n    pathString = // start at the left of the target node\n    'M ' + coords.targetX + ' ' + (coords.targetY - offset) + ' ' + 'L' + coords.rightInnerExtent + ' ' + (coords.targetY - offset) + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 0 ' + (coords.rightFullExtent - offset) + ' ' + (coords.targetY + coords.rightSmallArcRadius) + 'L' + (coords.rightFullExtent - offset) + ' ' + coords.verticalRightInnerExtent + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 0 ' + coords.rightInnerExtent + ' ' + (coords.verticalFullExtent + offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 0 ' + (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent + 'L' + (coords.leftFullExtent + offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 0 ' + coords.leftInnerExtent + ' ' + (coords.sourceY - offset) + 'L' + coords.sourceX + ' ' + (coords.sourceY - offset) + // Walking back\n    'L' + coords.sourceX + ' ' + (coords.sourceY + offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.sourceY + offset) + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 1 ' + (coords.leftFullExtent - offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) + 'L' + (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 1 ' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) + 'L' + coords.rightInnerExtent + ' ' + (coords.verticalFullExtent - offset) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 1 ' + (coords.rightFullExtent + offset) + ' ' + coords.verticalRightInnerExtent + 'L' + (coords.rightFullExtent + offset) + ' ' + (coords.targetY + coords.rightSmallArcRadius) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 1 ' + coords.rightInnerExtent + ' ' + (coords.targetY + offset) + 'L' + coords.targetX + ' ' + (coords.targetY + offset) + 'Z';\n  }\n\n  return pathString;\n}\n\nfunction linkPath() {\n  var curvature = 0.5;\n\n  function path(d) {\n    if (d.link.circular) {\n      return createCircularClosedPathString(d.link);\n    } else {\n      var x0 = d.link.source.x1;\n      var x1 = d.link.target.x0;\n      var xi = interpolateNumber(x0, x1);\n      var x2 = xi(curvature);\n      var x3 = xi(1 - curvature);\n      var y0a = d.link.y0 - d.link.width / 2;\n      var y0b = d.link.y0 + d.link.width / 2;\n      var y1a = d.link.y1 - d.link.width / 2;\n      var y1b = d.link.y1 + d.link.width / 2;\n      return 'M' + x0 + ',' + y0a + 'C' + x2 + ',' + y0a + ' ' + x3 + ',' + y1a + ' ' + x1 + ',' + y1a + 'L' + x1 + ',' + y1b + 'C' + x3 + ',' + y1b + ' ' + x2 + ',' + y0b + ' ' + x0 + ',' + y0b + 'Z';\n    }\n  }\n\n  return path;\n}\n\nfunction nodeModel(d, n) {\n  var tc = tinycolor(n.color);\n  var zoneThicknessPad = c.nodePadAcross;\n  var zoneLengthPad = d.nodePad / 2;\n  n.dx = n.x1 - n.x0;\n  n.dy = n.y1 - n.y0;\n  var visibleThickness = n.dx;\n  var visibleLength = Math.max(0.5, n.dy);\n  var key = 'node_' + n.pointNumber; // If it's a group, it's mutable and should be unique\n\n  if (n.group) {\n    key = Lib.randstr();\n  } // for event data\n\n\n  n.trace = d.trace;\n  n.curveNumber = d.trace.index;\n  return {\n    index: n.pointNumber,\n    key: key,\n    partOfGroup: n.partOfGroup || false,\n    group: n.group,\n    traceId: d.key,\n    trace: d.trace,\n    node: n,\n    nodePad: d.nodePad,\n    nodeLineColor: d.nodeLineColor,\n    nodeLineWidth: d.nodeLineWidth,\n    textFont: d.textFont,\n    size: d.horizontal ? d.height : d.width,\n    visibleWidth: Math.ceil(visibleThickness),\n    visibleHeight: visibleLength,\n    zoneX: -zoneThicknessPad,\n    zoneY: -zoneLengthPad,\n    zoneWidth: visibleThickness + 2 * zoneThicknessPad,\n    zoneHeight: visibleLength + 2 * zoneLengthPad,\n    labelY: d.horizontal ? n.dy / 2 + 1 : n.dx / 2 + 1,\n    left: n.originalLayer === 1,\n    sizeAcross: d.width,\n    forceLayouts: d.forceLayouts,\n    horizontal: d.horizontal,\n    darkBackground: tc.getBrightness() <= 128,\n    tinyColorHue: Color.tinyRGB(tc),\n    tinyColorAlpha: tc.getAlpha(),\n    valueFormat: d.valueFormat,\n    valueSuffix: d.valueSuffix,\n    sankey: d.sankey,\n    graph: d.graph,\n    arrangement: d.arrangement,\n    uniqueNodeLabelPathId: [d.guid, d.key, key].join('_'),\n    interactionState: d.interactionState,\n    figure: d\n  };\n} // rendering snippets\n\n\nfunction updateNodePositions(sankeyNode) {\n  sankeyNode.attr('transform', function (d) {\n    return strTranslate(d.node.x0.toFixed(3), d.node.y0.toFixed(3));\n  });\n}\n\nfunction updateNodeShapes(sankeyNode) {\n  sankeyNode.call(updateNodePositions);\n}\n\nfunction updateShapes(sankeyNode, sankeyLink) {\n  sankeyNode.call(updateNodeShapes);\n  sankeyLink.attr('d', linkPath());\n}\n\nfunction sizeNode(rect) {\n  rect.attr('width', function (d) {\n    return d.node.x1 - d.node.x0;\n  }).attr('height', function (d) {\n    return d.visibleHeight;\n  });\n}\n\nfunction salientEnough(d) {\n  return d.link.width > 1 || d.linkLineWidth > 0;\n}\n\nfunction sankeyTransform(d) {\n  var offset = strTranslate(d.translateX, d.translateY);\n  return offset + (d.horizontal ? 'matrix(1 0 0 1 0 0)' : 'matrix(0 1 1 0 0 0)');\n}\n\nfunction nodeCentering(d) {\n  return strTranslate(d.horizontal ? 0 : d.labelY, d.horizontal ? d.labelY : 0);\n}\n\nfunction textGuidePath(d) {\n  return d3.svg.line()([[d.horizontal ? d.left ? -d.sizeAcross : d.visibleWidth + c.nodeTextOffsetHorizontal : c.nodeTextOffsetHorizontal, 0], [d.horizontal ? d.left ? -c.nodeTextOffsetHorizontal : d.sizeAcross : d.visibleHeight - c.nodeTextOffsetHorizontal, 0]]);\n}\n\nfunction sankeyInverseTransform(d) {\n  return d.horizontal ? 'matrix(1 0 0 1 0 0)' : 'matrix(0 1 1 0 0 0)';\n}\n\nfunction textFlip(d) {\n  return d.horizontal ? 'scale(1 1)' : 'scale(-1 1)';\n}\n\nfunction nodeTextColor(d) {\n  return d.darkBackground && !d.horizontal ? 'rgb(255,255,255)' : 'rgb(0,0,0)';\n}\n\nfunction nodeTextOffset(d) {\n  return d.horizontal && d.left ? '100%' : '0%';\n} // event handling\n\n\nfunction attachPointerEvents(selection, sankey, eventSet) {\n  selection.on('.basic', null) // remove any preexisting handlers\n  .on('mouseover.basic', function (d) {\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.hover(this, d, sankey);\n      d.interactionState.hovered = [this, d];\n    }\n  }).on('mousemove.basic', function (d) {\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.follow(this, d);\n      d.interactionState.hovered = [this, d];\n    }\n  }).on('mouseout.basic', function (d) {\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.unhover(this, d, sankey);\n      d.interactionState.hovered = false;\n    }\n  }).on('click.basic', function (d) {\n    if (d.interactionState.hovered) {\n      eventSet.unhover(this, d, sankey);\n      d.interactionState.hovered = false;\n    }\n\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.select(this, d, sankey);\n    }\n  });\n}\n\nfunction attachDragHandler(sankeyNode, sankeyLink, callbacks, gd) {\n  var dragBehavior = d3.behavior.drag().origin(function (d) {\n    return {\n      x: d.node.x0 + d.visibleWidth / 2,\n      y: d.node.y0 + d.visibleHeight / 2\n    };\n  }).on('dragstart', function (d) {\n    if (d.arrangement === 'fixed') return;\n    Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'dragcover', function (s) {\n      gd._fullLayout._dragCover = s;\n    });\n    Lib.raiseToTop(this);\n    d.interactionState.dragInProgress = d.node;\n    saveCurrentDragPosition(d.node);\n\n    if (d.interactionState.hovered) {\n      callbacks.nodeEvents.unhover.apply(0, d.interactionState.hovered);\n      d.interactionState.hovered = false;\n    }\n\n    if (d.arrangement === 'snap') {\n      var forceKey = d.traceId + '|' + d.key;\n\n      if (d.forceLayouts[forceKey]) {\n        d.forceLayouts[forceKey].alpha(1);\n      } else {\n        // make a forceLayout if needed\n        attachForce(sankeyNode, forceKey, d, gd);\n      }\n\n      startForce(sankeyNode, sankeyLink, d, forceKey, gd);\n    }\n  }).on('drag', function (d) {\n    if (d.arrangement === 'fixed') return;\n    var x = d3.event.x;\n    var y = d3.event.y;\n\n    if (d.arrangement === 'snap') {\n      d.node.x0 = x - d.visibleWidth / 2;\n      d.node.x1 = x + d.visibleWidth / 2;\n      d.node.y0 = y - d.visibleHeight / 2;\n      d.node.y1 = y + d.visibleHeight / 2;\n    } else {\n      if (d.arrangement === 'freeform') {\n        d.node.x0 = x - d.visibleWidth / 2;\n        d.node.x1 = x + d.visibleWidth / 2;\n      }\n\n      y = Math.max(0, Math.min(d.size - d.visibleHeight / 2, y));\n      d.node.y0 = y - d.visibleHeight / 2;\n      d.node.y1 = y + d.visibleHeight / 2;\n    }\n\n    saveCurrentDragPosition(d.node);\n\n    if (d.arrangement !== 'snap') {\n      d.sankey.update(d.graph);\n      updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n    }\n  }).on('dragend', function (d) {\n    if (d.arrangement === 'fixed') return;\n    d.interactionState.dragInProgress = false;\n\n    for (var i = 0; i < d.node.childrenNodes.length; i++) {\n      d.node.childrenNodes[i].x = d.node.x;\n      d.node.childrenNodes[i].y = d.node.y;\n    }\n\n    if (d.arrangement !== 'snap') persistFinalNodePositions(d, gd);\n  });\n  sankeyNode.on('.drag', null) // remove possible previous handlers\n  .call(dragBehavior);\n}\n\nfunction attachForce(sankeyNode, forceKey, d, gd) {\n  // Attach force to nodes in the same column (same x coordinate)\n  switchToForceFormat(d.graph.nodes);\n  var nodes = d.graph.nodes.filter(function (n) {\n    return n.originalX === d.node.originalX;\n  }) // Filter out children\n  .filter(function (n) {\n    return !n.partOfGroup;\n  });\n  d.forceLayouts[forceKey] = d3Force.forceSimulation(nodes).alphaDecay(0).force('collide', d3Force.forceCollide().radius(function (n) {\n    return n.dy / 2 + d.nodePad / 2;\n  }).strength(1).iterations(c.forceIterations)).force('constrain', snappingForce(sankeyNode, forceKey, nodes, d, gd)).stop();\n}\n\nfunction startForce(sankeyNode, sankeyLink, d, forceKey, gd) {\n  window.requestAnimationFrame(function faster() {\n    var i;\n\n    for (i = 0; i < c.forceTicksPerFrame; i++) {\n      d.forceLayouts[forceKey].tick();\n    }\n\n    var nodes = d.graph.nodes;\n    switchToSankeyFormat(nodes);\n    d.sankey.update(d.graph);\n    updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n\n    if (d.forceLayouts[forceKey].alpha() > 0) {\n      window.requestAnimationFrame(faster);\n    } else {\n      // Make sure the final x position is equal to its original value\n      // because the force simulation will have numerical error\n      var x = d.node.originalX;\n      d.node.x0 = x - d.visibleWidth / 2;\n      d.node.x1 = x + d.visibleWidth / 2;\n      persistFinalNodePositions(d, gd);\n    }\n  });\n}\n\nfunction snappingForce(sankeyNode, forceKey, nodes, d) {\n  return function _snappingForce() {\n    var maxVelocity = 0;\n\n    for (var i = 0; i < nodes.length; i++) {\n      var n = nodes[i];\n\n      if (n === d.interactionState.dragInProgress) {\n        // constrain node position to the dragging pointer\n        n.x = n.lastDraggedX;\n        n.y = n.lastDraggedY;\n      } else {\n        n.vx = (n.originalX - n.x) / c.forceTicksPerFrame; // snap to layer\n\n        n.y = Math.min(d.size - n.dy / 2, Math.max(n.dy / 2, n.y)); // constrain to extent\n      }\n\n      maxVelocity = Math.max(maxVelocity, Math.abs(n.vx), Math.abs(n.vy));\n    }\n\n    if (!d.interactionState.dragInProgress && maxVelocity < 0.1 && d.forceLayouts[forceKey].alpha() > 0) {\n      d.forceLayouts[forceKey].alpha(0); // This will stop the animation loop\n    }\n  };\n} // basic data utilities\n\n\nfunction persistFinalNodePositions(d, gd) {\n  var x = [];\n  var y = [];\n\n  for (var i = 0; i < d.graph.nodes.length; i++) {\n    var nodeX = (d.graph.nodes[i].x0 + d.graph.nodes[i].x1) / 2;\n    var nodeY = (d.graph.nodes[i].y0 + d.graph.nodes[i].y1) / 2;\n    x.push(nodeX / d.figure.width);\n    y.push(nodeY / d.figure.height);\n  }\n\n  Registry.call('_guiRestyle', gd, {\n    'node.x': [x],\n    'node.y': [y]\n  }, d.trace.index).then(function () {\n    if (gd._fullLayout._dragCover) gd._fullLayout._dragCover.remove();\n  });\n}\n\nfunction persistOriginalPlace(nodes) {\n  var distinctLayerPositions = [];\n  var i;\n\n  for (i = 0; i < nodes.length; i++) {\n    nodes[i].originalX = (nodes[i].x0 + nodes[i].x1) / 2;\n    nodes[i].originalY = (nodes[i].y0 + nodes[i].y1) / 2;\n\n    if (distinctLayerPositions.indexOf(nodes[i].originalX) === -1) {\n      distinctLayerPositions.push(nodes[i].originalX);\n    }\n  }\n\n  distinctLayerPositions.sort(function (a, b) {\n    return a - b;\n  });\n\n  for (i = 0; i < nodes.length; i++) {\n    nodes[i].originalLayerIndex = distinctLayerPositions.indexOf(nodes[i].originalX);\n    nodes[i].originalLayer = nodes[i].originalLayerIndex / (distinctLayerPositions.length - 1);\n  }\n}\n\nfunction saveCurrentDragPosition(d) {\n  d.lastDraggedX = d.x0 + d.dx / 2;\n  d.lastDraggedY = d.y0 + d.dy / 2;\n}\n\nfunction sameLayer(d) {\n  return function (n) {\n    return n.node.originalX === d.node.originalX;\n  };\n}\n\nfunction switchToForceFormat(nodes) {\n  // force uses x, y as centers\n  for (var i = 0; i < nodes.length; i++) {\n    nodes[i].y = (nodes[i].y0 + nodes[i].y1) / 2;\n    nodes[i].x = (nodes[i].x0 + nodes[i].x1) / 2;\n  }\n}\n\nfunction switchToSankeyFormat(nodes) {\n  // sankey uses x0, x1, y0, y1\n  for (var i = 0; i < nodes.length; i++) {\n    nodes[i].y0 = nodes[i].y - nodes[i].dy / 2;\n    nodes[i].y1 = nodes[i].y0 + nodes[i].dy;\n    nodes[i].x0 = nodes[i].x - nodes[i].dx / 2;\n    nodes[i].x1 = nodes[i].x0 + nodes[i].dx;\n  }\n} // scene graph\n\n\nmodule.exports = function (gd, svg, calcData, layout, callbacks) {\n  // To prevent animation on first render\n  var firstRender = false;\n  Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'first-render', function () {\n    firstRender = true;\n  }); // To prevent animation on dragging\n\n  var dragcover = gd._fullLayout._dragCover;\n  var styledData = calcData.filter(function (d) {\n    return unwrap(d).trace.visible;\n  }).map(sankeyModel.bind(null, layout));\n  var sankey = svg.selectAll('.' + c.cn.sankey).data(styledData, keyFun);\n  sankey.exit().remove();\n  sankey.enter().append('g').classed(c.cn.sankey, true).style('box-sizing', 'content-box').style('position', 'absolute').style('left', 0).style('shape-rendering', 'geometricPrecision').style('pointer-events', 'auto').attr('transform', sankeyTransform);\n  sankey.each(function (d, i) {\n    gd._fullData[i]._sankey = d; // Create dragbox if missing\n\n    var dragboxClassName = 'bgsankey-' + d.trace.uid + '-' + i;\n    Lib.ensureSingle(gd._fullLayout._draggers, 'rect', dragboxClassName);\n    gd._fullData[i]._bgRect = d3.select('.' + dragboxClassName); // Style dragbox\n\n    gd._fullData[i]._bgRect.style('pointer-events', 'all').attr('width', d.width).attr('height', d.height).attr('x', d.translateX).attr('y', d.translateY).classed('bgsankey', true).style({\n      fill: 'transparent',\n      'stroke-width': 0\n    });\n  });\n  sankey.transition().ease(c.ease).duration(c.duration).attr('transform', sankeyTransform);\n  var sankeyLinks = sankey.selectAll('.' + c.cn.sankeyLinks).data(repeat, keyFun);\n  sankeyLinks.enter().append('g').classed(c.cn.sankeyLinks, true).style('fill', 'none');\n  var sankeyLink = sankeyLinks.selectAll('.' + c.cn.sankeyLink).data(function (d) {\n    var links = d.graph.links;\n    return links.filter(function (l) {\n      return l.value;\n    }).map(linkModel.bind(null, d));\n  }, keyFun);\n  sankeyLink.enter().append('path').classed(c.cn.sankeyLink, true).call(attachPointerEvents, sankey, callbacks.linkEvents);\n  sankeyLink.style('stroke', function (d) {\n    return salientEnough(d) ? Color.tinyRGB(tinycolor(d.linkLineColor)) : d.tinyColorHue;\n  }).style('stroke-opacity', function (d) {\n    return salientEnough(d) ? Color.opacity(d.linkLineColor) : d.tinyColorAlpha;\n  }).style('fill', function (d) {\n    return d.tinyColorHue;\n  }).style('fill-opacity', function (d) {\n    return d.tinyColorAlpha;\n  }).style('stroke-width', function (d) {\n    return salientEnough(d) ? d.linkLineWidth : 1;\n  }).attr('d', linkPath());\n  sankeyLink.style('opacity', function () {\n    return gd._context.staticPlot || firstRender || dragcover ? 1 : 0;\n  }).transition().ease(c.ease).duration(c.duration).style('opacity', 1);\n  sankeyLink.exit().transition().ease(c.ease).duration(c.duration).style('opacity', 0).remove();\n  var sankeyNodeSet = sankey.selectAll('.' + c.cn.sankeyNodeSet).data(repeat, keyFun);\n  sankeyNodeSet.enter().append('g').classed(c.cn.sankeyNodeSet, true);\n  sankeyNodeSet.style('cursor', function (d) {\n    switch (d.arrangement) {\n      case 'fixed':\n        return 'default';\n\n      case 'perpendicular':\n        return 'ns-resize';\n\n      default:\n        return 'move';\n    }\n  });\n  var sankeyNode = sankeyNodeSet.selectAll('.' + c.cn.sankeyNode).data(function (d) {\n    var nodes = d.graph.nodes;\n    persistOriginalPlace(nodes);\n    return nodes.map(nodeModel.bind(null, d));\n  }, keyFun);\n  sankeyNode.enter().append('g').classed(c.cn.sankeyNode, true).call(updateNodePositions).style('opacity', function (n) {\n    return (gd._context.staticPlot || firstRender) && !n.partOfGroup ? 1 : 0;\n  });\n  sankeyNode.call(attachPointerEvents, sankey, callbacks.nodeEvents).call(attachDragHandler, sankeyLink, callbacks, gd); // has to be here as it binds sankeyLink\n\n  sankeyNode.transition().ease(c.ease).duration(c.duration).call(updateNodePositions).style('opacity', function (n) {\n    return n.partOfGroup ? 0 : 1;\n  });\n  sankeyNode.exit().transition().ease(c.ease).duration(c.duration).style('opacity', 0).remove();\n  var nodeRect = sankeyNode.selectAll('.' + c.cn.nodeRect).data(repeat);\n  nodeRect.enter().append('rect').classed(c.cn.nodeRect, true).call(sizeNode);\n  nodeRect.style('stroke-width', function (d) {\n    return d.nodeLineWidth;\n  }).style('stroke', function (d) {\n    return Color.tinyRGB(tinycolor(d.nodeLineColor));\n  }).style('stroke-opacity', function (d) {\n    return Color.opacity(d.nodeLineColor);\n  }).style('fill', function (d) {\n    return d.tinyColorHue;\n  }).style('fill-opacity', function (d) {\n    return d.tinyColorAlpha;\n  });\n  nodeRect.transition().ease(c.ease).duration(c.duration).call(sizeNode);\n  var nodeCapture = sankeyNode.selectAll('.' + c.cn.nodeCapture).data(repeat);\n  nodeCapture.enter().append('rect').classed(c.cn.nodeCapture, true).style('fill-opacity', 0);\n  nodeCapture.attr('x', function (d) {\n    return d.zoneX;\n  }).attr('y', function (d) {\n    return d.zoneY;\n  }).attr('width', function (d) {\n    return d.zoneWidth;\n  }).attr('height', function (d) {\n    return d.zoneHeight;\n  });\n  var nodeCentered = sankeyNode.selectAll('.' + c.cn.nodeCentered).data(repeat);\n  nodeCentered.enter().append('g').classed(c.cn.nodeCentered, true).attr('transform', nodeCentering);\n  nodeCentered.transition().ease(c.ease).duration(c.duration).attr('transform', nodeCentering);\n  var nodeLabelGuide = nodeCentered.selectAll('.' + c.cn.nodeLabelGuide).data(repeat);\n  nodeLabelGuide.enter().append('path').classed(c.cn.nodeLabelGuide, true).attr('id', function (d) {\n    return d.uniqueNodeLabelPathId;\n  }).attr('d', textGuidePath).attr('transform', sankeyInverseTransform);\n  nodeLabelGuide.transition().ease(c.ease).duration(c.duration).attr('d', textGuidePath).attr('transform', sankeyInverseTransform);\n  var nodeLabel = nodeCentered.selectAll('.' + c.cn.nodeLabel).data(repeat);\n  nodeLabel.enter().append('text').classed(c.cn.nodeLabel, true).attr('transform', textFlip).style('cursor', 'default').style('fill', 'black');\n  nodeLabel.style('text-shadow', function (d) {\n    return d.horizontal ? '-1px 1px 1px #fff, 1px 1px 1px #fff, 1px -1px 1px #fff, -1px -1px 1px #fff' : 'none';\n  }).each(function (d) {\n    Drawing.font(nodeLabel, d.textFont);\n  });\n  nodeLabel.transition().ease(c.ease).duration(c.duration).attr('transform', textFlip);\n  var nodeLabelTextPath = nodeLabel.selectAll('.' + c.cn.nodeLabelTextPath).data(repeat);\n  nodeLabelTextPath.enter().append('textPath').classed(c.cn.nodeLabelTextPath, true).attr('alignment-baseline', 'middle').attr('xlink:href', function (d) {\n    return '#' + d.uniqueNodeLabelPathId;\n  }).attr('startOffset', nodeTextOffset).style('fill', nodeTextColor);\n  nodeLabelTextPath.text(function (d) {\n    return d.horizontal || d.node.dy > 5 ? d.node.label : '';\n  }).attr('text-anchor', function (d) {\n    return d.horizontal && d.left ? 'end' : 'start';\n  });\n  nodeLabelTextPath.transition().ease(c.ease).duration(c.duration).attr('startOffset', nodeTextOffset).style('fill', nodeTextColor);\n};","map":{"version":3,"sources":["/Users/caseyrudick/Documents/landsharkrefactored-copy/client/node_modules/plotly.js/src/traces/sankey/render.js"],"names":["c","require","d3","tinycolor","Color","Drawing","d3Sankey","d3SankeyCircular","d3Force","Lib","strTranslate","gup","keyFun","repeat","unwrap","interpolateNumber","Registry","sankeyModel","layout","d","traceIndex","calcData","trace","domain","horizontal","orientation","nodePad","node","pad","nodeThickness","thickness","width","x","height","y","nodes","_nodes","links","_links","circular","sankey","sankeyCircular","circularLinkGap","iterations","sankeyIterations","size","nodeWidth","nodePadding","nodeId","pointNumber","graph","warn","i","j","k","nodePointNumber","_groupLookup","groupIndex","parseInt","groupingNode","length","child","x0","x1","y0","y1","partOfGroup","sourceLinks","targetLinks","unshift","childrenNodes","computeLinkConcentrations","flows","flowKey","link","source","target","hasOwnProperty","push","keys","Object","flowLinks","total","totalPerLabel","label","value","flow","labelConcentration","concentration","concentrationscale","color","totalOutflow","concentrationOut","totalInflow","concenrationIn","resolveCollisionsTopToBottom","columns","forEach","dy","n","sort","a","b","snapToColumns","orderedNodes","map","index","colNumber","colX","lastX","Infinity","dx","Math","min","pos","nodeHeight","arrangement","update","key","guid","randstr","nodeLineColor","line","nodeLineWidth","linkLineColor","linkLineWidth","valueFormat","valueformat","valueSuffix","valuesuffix","textFont","textfont","translateX","margin","l","translateY","t","dragParallel","dragPerpendicular","forceLayouts","interactionState","dragInProgress","hovered","linkModel","tc","basicKey","curveNumber","traceId","tinyColorHue","tinyRGB","tinyColorAlpha","getAlpha","linkPath","parent","createCircularClosedPathString","pathString","offset","coords","circularPathData","circularLinkType","targetX","targetY","rightInnerExtent","rightLargeArcRadius","rightSmallArcRadius","rightFullExtent","verticalRightInnerExtent","verticalFullExtent","leftInnerExtent","leftLargeArcRadius","leftFullExtent","verticalLeftInnerExtent","sourceY","leftSmallArcRadius","sourceX","curvature","path","xi","x2","x3","y0a","y0b","y1a","y1b","nodeModel","zoneThicknessPad","nodePadAcross","zoneLengthPad","visibleThickness","visibleLength","max","group","visibleWidth","ceil","visibleHeight","zoneX","zoneY","zoneWidth","zoneHeight","labelY","left","originalLayer","sizeAcross","darkBackground","getBrightness","uniqueNodeLabelPathId","join","figure","updateNodePositions","sankeyNode","attr","toFixed","updateNodeShapes","call","updateShapes","sankeyLink","sizeNode","rect","salientEnough","sankeyTransform","nodeCentering","textGuidePath","svg","nodeTextOffsetHorizontal","sankeyInverseTransform","textFlip","nodeTextColor","nodeTextOffset","attachPointerEvents","selection","eventSet","on","hover","follow","unhover","select","attachDragHandler","callbacks","gd","dragBehavior","behavior","drag","origin","ensureSingle","_fullLayout","_infolayer","s","_dragCover","raiseToTop","saveCurrentDragPosition","nodeEvents","apply","forceKey","alpha","attachForce","startForce","event","filter","sameLayer","persistFinalNodePositions","switchToForceFormat","originalX","forceSimulation","alphaDecay","force","forceCollide","radius","strength","forceIterations","snappingForce","stop","window","requestAnimationFrame","faster","forceTicksPerFrame","tick","switchToSankeyFormat","_snappingForce","maxVelocity","lastDraggedX","lastDraggedY","vx","abs","vy","nodeX","nodeY","then","remove","persistOriginalPlace","distinctLayerPositions","originalY","indexOf","originalLayerIndex","module","exports","firstRender","dragcover","styledData","visible","bind","selectAll","cn","data","exit","enter","append","classed","style","each","_fullData","_sankey","dragboxClassName","uid","_draggers","_bgRect","fill","transition","ease","duration","sankeyLinks","linkEvents","opacity","_context","staticPlot","sankeyNodeSet","nodeRect","nodeCapture","nodeCentered","nodeLabelGuide","nodeLabel","font","nodeLabelTextPath","text"],"mappings":"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","sourcesContent":["/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n\n'use strict';\n\nvar c = require('./constants');\nvar d3 = require('d3');\nvar tinycolor = require('tinycolor2');\nvar Color = require('../../components/color');\nvar Drawing = require('../../components/drawing');\nvar d3Sankey = require('@plotly/d3-sankey');\nvar d3SankeyCircular = require('@plotly/d3-sankey-circular');\nvar d3Force = require('d3-force');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar gup = require('../../lib/gup');\nvar keyFun = gup.keyFun;\nvar repeat = gup.repeat;\nvar unwrap = gup.unwrap;\nvar interpolateNumber = require('d3-interpolate').interpolateNumber;\n\nvar Registry = require('../../registry');\n\n// view models\n\nfunction sankeyModel(layout, d, traceIndex) {\n    var calcData = unwrap(d);\n    var trace = calcData.trace;\n    var domain = trace.domain;\n    var horizontal = trace.orientation === 'h';\n    var nodePad = trace.node.pad;\n    var nodeThickness = trace.node.thickness;\n\n    var width = layout.width * (domain.x[1] - domain.x[0]);\n    var height = layout.height * (domain.y[1] - domain.y[0]);\n\n    var nodes = calcData._nodes;\n    var links = calcData._links;\n    var circular = calcData.circular;\n\n    // Select Sankey generator\n    var sankey;\n    if(circular) {\n        sankey = d3SankeyCircular\n            .sankeyCircular()\n            .circularLinkGap(0);\n    } else {\n        sankey = d3Sankey.sankey();\n    }\n\n    sankey\n      .iterations(c.sankeyIterations)\n      .size(horizontal ? [width, height] : [height, width])\n      .nodeWidth(nodeThickness)\n      .nodePadding(nodePad)\n      .nodeId(function(d) {\n          return d.pointNumber;\n      })\n      .nodes(nodes)\n      .links(links);\n\n    var graph = sankey();\n\n    if(sankey.nodePadding() < nodePad) {\n        Lib.warn('node.pad was reduced to ', sankey.nodePadding(), ' to fit within the figure.');\n    }\n\n    // Counters for nested loops\n    var i, j, k;\n\n    // Create transient nodes for animations\n    for(var nodePointNumber in calcData._groupLookup) {\n        var groupIndex = parseInt(calcData._groupLookup[nodePointNumber]);\n\n        // Find node representing groupIndex\n        var groupingNode;\n\n        for(i = 0; i < graph.nodes.length; i++) {\n            if(graph.nodes[i].pointNumber === groupIndex) {\n                groupingNode = graph.nodes[i];\n                break;\n            }\n        }\n        // If groupinNode is undefined, no links are targeting this group\n        if(!groupingNode) continue;\n\n        var child = {\n            pointNumber: parseInt(nodePointNumber),\n            x0: groupingNode.x0,\n            x1: groupingNode.x1,\n            y0: groupingNode.y0,\n            y1: groupingNode.y1,\n            partOfGroup: true,\n            sourceLinks: [],\n            targetLinks: []\n        };\n\n        graph.nodes.unshift(child);\n        groupingNode.childrenNodes.unshift(child);\n    }\n\n    function computeLinkConcentrations() {\n        for(i = 0; i < graph.nodes.length; i++) {\n            var node = graph.nodes[i];\n            // Links connecting the same two nodes are part of a flow\n            var flows = {};\n            var flowKey;\n            var link;\n            for(j = 0; j < node.targetLinks.length; j++) {\n                link = node.targetLinks[j];\n                flowKey = link.source.pointNumber + ':' + link.target.pointNumber;\n                if(!flows.hasOwnProperty(flowKey)) flows[flowKey] = [];\n                flows[flowKey].push(link);\n            }\n\n            // Compute statistics for each flow\n            var keys = Object.keys(flows);\n            for(j = 0; j < keys.length; j++) {\n                flowKey = keys[j];\n                var flowLinks = flows[flowKey];\n\n                // Find the total size of the flow and total size per label\n                var total = 0;\n                var totalPerLabel = {};\n                for(k = 0; k < flowLinks.length; k++) {\n                    link = flowLinks[k];\n                    if(!totalPerLabel[link.label]) totalPerLabel[link.label] = 0;\n                    totalPerLabel[link.label] += link.value;\n                    total += link.value;\n                }\n\n                // Find the ratio of the link's value and the size of the flow\n                for(k = 0; k < flowLinks.length; k++) {\n                    link = flowLinks[k];\n                    link.flow = {\n                        value: total,\n                        labelConcentration: totalPerLabel[link.label] / total,\n                        concentration: link.value / total,\n                        links: flowLinks\n                    };\n                    if(link.concentrationscale) {\n                        link.color = tinycolor(link.concentrationscale(link.flow.labelConcentration));\n                    }\n                }\n            }\n\n            // Gather statistics of all links at current node\n            var totalOutflow = 0;\n            for(j = 0; j < node.sourceLinks.length; j++) {\n                totalOutflow += node.sourceLinks[j].value;\n            }\n            for(j = 0; j < node.sourceLinks.length; j++) {\n                link = node.sourceLinks[j];\n                link.concentrationOut = link.value / totalOutflow;\n            }\n\n            var totalInflow = 0;\n            for(j = 0; j < node.targetLinks.length; j++) {\n                totalInflow += node.targetLinks[j].value;\n            }\n\n            for(j = 0; j < node.targetLinks.length; j++) {\n                link = node.targetLinks[j];\n                link.concenrationIn = link.value / totalInflow;\n            }\n        }\n    }\n    computeLinkConcentrations();\n\n    // Push any overlapping nodes down.\n    function resolveCollisionsTopToBottom(columns) {\n        columns.forEach(function(nodes) {\n            var node;\n            var dy;\n            var y = 0;\n            var n = nodes.length;\n            var i;\n            nodes.sort(function(a, b) {\n                return a.y0 - b.y0;\n            });\n            for(i = 0; i < n; ++i) {\n                node = nodes[i];\n                if(node.y0 >= y) {\n                    // No overlap\n                } else {\n                    dy = (y - node.y0);\n                    if(dy > 1e-6) node.y0 += dy, node.y1 += dy;\n                }\n                y = node.y1 + nodePad;\n            }\n        });\n    }\n\n    // Group nodes into columns based on their x position\n    function snapToColumns(nodes) {\n        // Sort nodes by x position\n        var orderedNodes = nodes.map(function(n, i) {\n            return {\n                x0: n.x0,\n                index: i\n            };\n        })\n        .sort(function(a, b) {\n            return a.x0 - b.x0;\n        });\n\n        var columns = [];\n        var colNumber = -1;\n        var colX; // Position of column\n        var lastX = -Infinity; // Position of last node\n        var dx;\n        for(i = 0; i < orderedNodes.length; i++) {\n            var node = nodes[orderedNodes[i].index];\n            // If the node does not overlap with the last one\n            if(node.x0 > lastX + nodeThickness) {\n                // Start a new column\n                colNumber += 1;\n                colX = node.x0;\n            }\n            lastX = node.x0;\n\n            // Add node to its associated column\n            if(!columns[colNumber]) columns[colNumber] = [];\n            columns[colNumber].push(node);\n\n            // Change node's x position to align it with its column\n            dx = colX - node.x0;\n            node.x0 += dx, node.x1 += dx;\n        }\n        return columns;\n    }\n\n    // Force node position\n    if(trace.node.x.length && trace.node.y.length) {\n        for(i = 0; i < Math.min(trace.node.x.length, trace.node.y.length, graph.nodes.length); i++) {\n            if(trace.node.x[i] && trace.node.y[i]) {\n                var pos = [trace.node.x[i] * width, trace.node.y[i] * height];\n                graph.nodes[i].x0 = pos[0] - nodeThickness / 2;\n                graph.nodes[i].x1 = pos[0] + nodeThickness / 2;\n\n                var nodeHeight = graph.nodes[i].y1 - graph.nodes[i].y0;\n                graph.nodes[i].y0 = pos[1] - nodeHeight / 2;\n                graph.nodes[i].y1 = pos[1] + nodeHeight / 2;\n            }\n        }\n        if(trace.arrangement === 'snap') {\n            nodes = graph.nodes;\n            var columns = snapToColumns(nodes);\n            resolveCollisionsTopToBottom(columns);\n        }\n        // Update links\n        sankey.update(graph);\n    }\n\n\n    return {\n        circular: circular,\n        key: traceIndex,\n        trace: trace,\n        guid: Lib.randstr(),\n        horizontal: horizontal,\n        width: width,\n        height: height,\n        nodePad: trace.node.pad,\n        nodeLineColor: trace.node.line.color,\n        nodeLineWidth: trace.node.line.width,\n        linkLineColor: trace.link.line.color,\n        linkLineWidth: trace.link.line.width,\n        valueFormat: trace.valueformat,\n        valueSuffix: trace.valuesuffix,\n        textFont: trace.textfont,\n        translateX: domain.x[0] * layout.width + layout.margin.l,\n        translateY: layout.height - domain.y[1] * layout.height + layout.margin.t,\n        dragParallel: horizontal ? height : width,\n        dragPerpendicular: horizontal ? width : height,\n        arrangement: trace.arrangement,\n        sankey: sankey,\n        graph: graph,\n        forceLayouts: {},\n        interactionState: {\n            dragInProgress: false,\n            hovered: false\n        }\n    };\n}\n\nfunction linkModel(d, l, i) {\n    var tc = tinycolor(l.color);\n    var basicKey = l.source.label + '|' + l.target.label;\n    var key = basicKey + '__' + i;\n\n    // for event data\n    l.trace = d.trace;\n    l.curveNumber = d.trace.index;\n\n    return {\n        circular: d.circular,\n        key: key,\n        traceId: d.key,\n        pointNumber: l.pointNumber,\n        link: l,\n        tinyColorHue: Color.tinyRGB(tc),\n        tinyColorAlpha: tc.getAlpha(),\n        linkPath: linkPath,\n        linkLineColor: d.linkLineColor,\n        linkLineWidth: d.linkLineWidth,\n        valueFormat: d.valueFormat,\n        valueSuffix: d.valueSuffix,\n        sankey: d.sankey,\n        parent: d,\n        interactionState: d.interactionState,\n        flow: l.flow\n    };\n}\n\nfunction createCircularClosedPathString(link) {\n    // Using coordinates computed by d3-sankey-circular\n    var pathString = '';\n    var offset = link.width / 2;\n    var coords = link.circularPathData;\n    if(link.circularLinkType === 'top') {\n        // Top path\n        pathString =\n          // start at the left of the target node\n          'M ' +\n          coords.targetX + ' ' + (coords.targetY + offset) + ' ' +\n          'L' +\n          coords.rightInnerExtent + ' ' + (coords.targetY + offset) +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 1 ' +\n          (coords.rightFullExtent - offset) + ' ' + (coords.targetY - coords.rightSmallArcRadius) +\n          'L' +\n          (coords.rightFullExtent - offset) + ' ' + coords.verticalRightInnerExtent +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 1 ' +\n          coords.rightInnerExtent + ' ' + (coords.verticalFullExtent - offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 1 ' +\n          (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent +\n          'L' +\n          (coords.leftFullExtent + offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 1 ' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY + offset) +\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY + offset) +\n\n          // Walking back\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY - offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY - offset) +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 0 ' +\n          (coords.leftFullExtent - offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) +\n          'L' +\n          (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 0 ' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) +\n          'L' +\n          coords.rightInnerExtent + ' ' + (coords.verticalFullExtent + offset) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 0 ' +\n          (coords.rightFullExtent + offset) + ' ' + coords.verticalRightInnerExtent +\n          'L' +\n          (coords.rightFullExtent + offset) + ' ' + (coords.targetY - coords.rightSmallArcRadius) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 0 ' +\n          coords.rightInnerExtent + ' ' + (coords.targetY - offset) +\n          'L' +\n          coords.targetX + ' ' + (coords.targetY - offset) +\n          'Z';\n    } else {\n        // Bottom path\n        pathString =\n          // start at the left of the target node\n          'M ' +\n          coords.targetX + ' ' + (coords.targetY - offset) + ' ' +\n          'L' +\n          coords.rightInnerExtent + ' ' + (coords.targetY - offset) +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 0 ' +\n          (coords.rightFullExtent - offset) + ' ' + (coords.targetY + coords.rightSmallArcRadius) +\n          'L' +\n          (coords.rightFullExtent - offset) + ' ' + coords.verticalRightInnerExtent +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 0 ' +\n          coords.rightInnerExtent + ' ' + (coords.verticalFullExtent + offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 0 ' +\n          (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent +\n          'L' +\n          (coords.leftFullExtent + offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 0 ' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY - offset) +\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY - offset) +\n\n          // Walking back\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY + offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY + offset) +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 1 ' +\n          (coords.leftFullExtent - offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) +\n          'L' +\n          (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 1 ' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) +\n          'L' +\n          coords.rightInnerExtent + ' ' + (coords.verticalFullExtent - offset) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 1 ' +\n          (coords.rightFullExtent + offset) + ' ' + coords.verticalRightInnerExtent +\n          'L' +\n          (coords.rightFullExtent + offset) + ' ' + (coords.targetY + coords.rightSmallArcRadius) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 1 ' +\n          coords.rightInnerExtent + ' ' + (coords.targetY + offset) +\n          'L' +\n          coords.targetX + ' ' + (coords.targetY + offset) +\n          'Z';\n    }\n    return pathString;\n}\n\nfunction linkPath() {\n    var curvature = 0.5;\n    function path(d) {\n        if(d.link.circular) {\n            return createCircularClosedPathString(d.link);\n        } else {\n            var x0 = d.link.source.x1;\n            var x1 = d.link.target.x0;\n            var xi = interpolateNumber(x0, x1);\n            var x2 = xi(curvature);\n            var x3 = xi(1 - curvature);\n            var y0a = d.link.y0 - d.link.width / 2;\n            var y0b = d.link.y0 + d.link.width / 2;\n            var y1a = d.link.y1 - d.link.width / 2;\n            var y1b = d.link.y1 + d.link.width / 2;\n            return 'M' + x0 + ',' + y0a +\n                 'C' + x2 + ',' + y0a +\n                 ' ' + x3 + ',' + y1a +\n                 ' ' + x1 + ',' + y1a +\n                 'L' + x1 + ',' + y1b +\n                 'C' + x3 + ',' + y1b +\n                 ' ' + x2 + ',' + y0b +\n                 ' ' + x0 + ',' + y0b +\n                 'Z';\n        }\n    }\n    return path;\n}\n\nfunction nodeModel(d, n) {\n    var tc = tinycolor(n.color);\n    var zoneThicknessPad = c.nodePadAcross;\n    var zoneLengthPad = d.nodePad / 2;\n    n.dx = n.x1 - n.x0;\n    n.dy = n.y1 - n.y0;\n    var visibleThickness = n.dx;\n    var visibleLength = Math.max(0.5, n.dy);\n\n    var key = 'node_' + n.pointNumber;\n    // If it's a group, it's mutable and should be unique\n    if(n.group) {\n        key = Lib.randstr();\n    }\n\n    // for event data\n    n.trace = d.trace;\n    n.curveNumber = d.trace.index;\n\n    return {\n        index: n.pointNumber,\n        key: key,\n        partOfGroup: n.partOfGroup || false,\n        group: n.group,\n        traceId: d.key,\n        trace: d.trace,\n        node: n,\n        nodePad: d.nodePad,\n        nodeLineColor: d.nodeLineColor,\n        nodeLineWidth: d.nodeLineWidth,\n        textFont: d.textFont,\n        size: d.horizontal ? d.height : d.width,\n        visibleWidth: Math.ceil(visibleThickness),\n        visibleHeight: visibleLength,\n        zoneX: -zoneThicknessPad,\n        zoneY: -zoneLengthPad,\n        zoneWidth: visibleThickness + 2 * zoneThicknessPad,\n        zoneHeight: visibleLength + 2 * zoneLengthPad,\n        labelY: d.horizontal ? n.dy / 2 + 1 : n.dx / 2 + 1,\n        left: n.originalLayer === 1,\n        sizeAcross: d.width,\n        forceLayouts: d.forceLayouts,\n        horizontal: d.horizontal,\n        darkBackground: tc.getBrightness() <= 128,\n        tinyColorHue: Color.tinyRGB(tc),\n        tinyColorAlpha: tc.getAlpha(),\n        valueFormat: d.valueFormat,\n        valueSuffix: d.valueSuffix,\n        sankey: d.sankey,\n        graph: d.graph,\n        arrangement: d.arrangement,\n        uniqueNodeLabelPathId: [d.guid, d.key, key].join('_'),\n        interactionState: d.interactionState,\n        figure: d\n    };\n}\n\n// rendering snippets\n\nfunction updateNodePositions(sankeyNode) {\n    sankeyNode\n        .attr('transform', function(d) {\n            return strTranslate(d.node.x0.toFixed(3), (d.node.y0).toFixed(3));\n        });\n}\n\nfunction updateNodeShapes(sankeyNode) {\n    sankeyNode.call(updateNodePositions);\n}\n\nfunction updateShapes(sankeyNode, sankeyLink) {\n    sankeyNode.call(updateNodeShapes);\n    sankeyLink.attr('d', linkPath());\n}\n\nfunction sizeNode(rect) {\n    rect\n      .attr('width', function(d) {return d.node.x1 - d.node.x0;})\n      .attr('height', function(d) {return d.visibleHeight;});\n}\n\nfunction salientEnough(d) {return (d.link.width > 1 || d.linkLineWidth > 0);}\n\nfunction sankeyTransform(d) {\n    var offset = strTranslate(d.translateX, d.translateY);\n    return offset + (d.horizontal ? 'matrix(1 0 0 1 0 0)' : 'matrix(0 1 1 0 0 0)');\n}\n\nfunction nodeCentering(d) {\n    return strTranslate(d.horizontal ? 0 : d.labelY, d.horizontal ? d.labelY : 0);\n}\n\nfunction textGuidePath(d) {\n    return d3.svg.line()([\n        [d.horizontal ? (d.left ? -d.sizeAcross : d.visibleWidth + c.nodeTextOffsetHorizontal) : c.nodeTextOffsetHorizontal, 0],\n        [d.horizontal ? (d.left ? - c.nodeTextOffsetHorizontal : d.sizeAcross) : d.visibleHeight - c.nodeTextOffsetHorizontal, 0]\n    ]);\n}\n\nfunction sankeyInverseTransform(d) {return d.horizontal ? 'matrix(1 0 0 1 0 0)' : 'matrix(0 1 1 0 0 0)';}\nfunction textFlip(d) {return d.horizontal ? 'scale(1 1)' : 'scale(-1 1)';}\nfunction nodeTextColor(d) {return d.darkBackground && !d.horizontal ? 'rgb(255,255,255)' : 'rgb(0,0,0)';}\nfunction nodeTextOffset(d) {return d.horizontal && d.left ? '100%' : '0%';}\n\n// event handling\n\nfunction attachPointerEvents(selection, sankey, eventSet) {\n    selection\n        .on('.basic', null) // remove any preexisting handlers\n        .on('mouseover.basic', function(d) {\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.hover(this, d, sankey);\n                d.interactionState.hovered = [this, d];\n            }\n        })\n        .on('mousemove.basic', function(d) {\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.follow(this, d);\n                d.interactionState.hovered = [this, d];\n            }\n        })\n        .on('mouseout.basic', function(d) {\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.unhover(this, d, sankey);\n                d.interactionState.hovered = false;\n            }\n        })\n        .on('click.basic', function(d) {\n            if(d.interactionState.hovered) {\n                eventSet.unhover(this, d, sankey);\n                d.interactionState.hovered = false;\n            }\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.select(this, d, sankey);\n            }\n        });\n}\n\nfunction attachDragHandler(sankeyNode, sankeyLink, callbacks, gd) {\n    var dragBehavior = d3.behavior.drag()\n        .origin(function(d) {\n            return {\n                x: d.node.x0 + d.visibleWidth / 2,\n                y: d.node.y0 + d.visibleHeight / 2\n            };\n        })\n\n        .on('dragstart', function(d) {\n            if(d.arrangement === 'fixed') return;\n            Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'dragcover', function(s) {\n                gd._fullLayout._dragCover = s;\n            });\n            Lib.raiseToTop(this);\n            d.interactionState.dragInProgress = d.node;\n\n            saveCurrentDragPosition(d.node);\n            if(d.interactionState.hovered) {\n                callbacks.nodeEvents.unhover.apply(0, d.interactionState.hovered);\n                d.interactionState.hovered = false;\n            }\n            if(d.arrangement === 'snap') {\n                var forceKey = d.traceId + '|' + d.key;\n                if(d.forceLayouts[forceKey]) {\n                    d.forceLayouts[forceKey].alpha(1);\n                } else { // make a forceLayout if needed\n                    attachForce(sankeyNode, forceKey, d, gd);\n                }\n                startForce(sankeyNode, sankeyLink, d, forceKey, gd);\n            }\n        })\n\n        .on('drag', function(d) {\n            if(d.arrangement === 'fixed') return;\n            var x = d3.event.x;\n            var y = d3.event.y;\n            if(d.arrangement === 'snap') {\n                d.node.x0 = x - d.visibleWidth / 2;\n                d.node.x1 = x + d.visibleWidth / 2;\n                d.node.y0 = y - d.visibleHeight / 2;\n                d.node.y1 = y + d.visibleHeight / 2;\n            } else {\n                if(d.arrangement === 'freeform') {\n                    d.node.x0 = x - d.visibleWidth / 2;\n                    d.node.x1 = x + d.visibleWidth / 2;\n                }\n                y = Math.max(0, Math.min(d.size - d.visibleHeight / 2, y));\n                d.node.y0 = y - d.visibleHeight / 2;\n                d.node.y1 = y + d.visibleHeight / 2;\n            }\n\n            saveCurrentDragPosition(d.node);\n            if(d.arrangement !== 'snap') {\n                d.sankey.update(d.graph);\n                updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n            }\n        })\n\n        .on('dragend', function(d) {\n            if(d.arrangement === 'fixed') return;\n            d.interactionState.dragInProgress = false;\n            for(var i = 0; i < d.node.childrenNodes.length; i++) {\n                d.node.childrenNodes[i].x = d.node.x;\n                d.node.childrenNodes[i].y = d.node.y;\n            }\n            if(d.arrangement !== 'snap') persistFinalNodePositions(d, gd);\n        });\n\n    sankeyNode\n        .on('.drag', null) // remove possible previous handlers\n        .call(dragBehavior);\n}\n\nfunction attachForce(sankeyNode, forceKey, d, gd) {\n    // Attach force to nodes in the same column (same x coordinate)\n    switchToForceFormat(d.graph.nodes);\n    var nodes = d.graph.nodes\n        .filter(function(n) {return n.originalX === d.node.originalX;})\n        // Filter out children\n        .filter(function(n) {return !n.partOfGroup;});\n    d.forceLayouts[forceKey] = d3Force.forceSimulation(nodes)\n        .alphaDecay(0)\n        .force('collide', d3Force.forceCollide()\n            .radius(function(n) {return n.dy / 2 + d.nodePad / 2;})\n            .strength(1)\n            .iterations(c.forceIterations))\n        .force('constrain', snappingForce(sankeyNode, forceKey, nodes, d, gd))\n        .stop();\n}\n\nfunction startForce(sankeyNode, sankeyLink, d, forceKey, gd) {\n    window.requestAnimationFrame(function faster() {\n        var i;\n        for(i = 0; i < c.forceTicksPerFrame; i++) {\n            d.forceLayouts[forceKey].tick();\n        }\n\n        var nodes = d.graph.nodes;\n        switchToSankeyFormat(nodes);\n\n        d.sankey.update(d.graph);\n        updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n\n        if(d.forceLayouts[forceKey].alpha() > 0) {\n            window.requestAnimationFrame(faster);\n        } else {\n            // Make sure the final x position is equal to its original value\n            // because the force simulation will have numerical error\n            var x = d.node.originalX;\n            d.node.x0 = x - d.visibleWidth / 2;\n            d.node.x1 = x + d.visibleWidth / 2;\n\n            persistFinalNodePositions(d, gd);\n        }\n    });\n}\n\nfunction snappingForce(sankeyNode, forceKey, nodes, d) {\n    return function _snappingForce() {\n        var maxVelocity = 0;\n        for(var i = 0; i < nodes.length; i++) {\n            var n = nodes[i];\n            if(n === d.interactionState.dragInProgress) { // constrain node position to the dragging pointer\n                n.x = n.lastDraggedX;\n                n.y = n.lastDraggedY;\n            } else {\n                n.vx = (n.originalX - n.x) / c.forceTicksPerFrame; // snap to layer\n                n.y = Math.min(d.size - n.dy / 2, Math.max(n.dy / 2, n.y)); // constrain to extent\n            }\n            maxVelocity = Math.max(maxVelocity, Math.abs(n.vx), Math.abs(n.vy));\n        }\n        if(!d.interactionState.dragInProgress && maxVelocity < 0.1 && d.forceLayouts[forceKey].alpha() > 0) {\n            d.forceLayouts[forceKey].alpha(0); // This will stop the animation loop\n        }\n    };\n}\n\n// basic data utilities\n\nfunction persistFinalNodePositions(d, gd) {\n    var x = [];\n    var y = [];\n    for(var i = 0; i < d.graph.nodes.length; i++) {\n        var nodeX = (d.graph.nodes[i].x0 + d.graph.nodes[i].x1) / 2;\n        var nodeY = (d.graph.nodes[i].y0 + d.graph.nodes[i].y1) / 2;\n        x.push(nodeX / d.figure.width);\n        y.push(nodeY / d.figure.height);\n    }\n    Registry.call('_guiRestyle', gd, {\n        'node.x': [x],\n        'node.y': [y]\n    }, d.trace.index)\n    .then(function() {\n        if(gd._fullLayout._dragCover) gd._fullLayout._dragCover.remove();\n    });\n}\n\nfunction persistOriginalPlace(nodes) {\n    var distinctLayerPositions = [];\n    var i;\n    for(i = 0; i < nodes.length; i++) {\n        nodes[i].originalX = (nodes[i].x0 + nodes[i].x1) / 2;\n        nodes[i].originalY = (nodes[i].y0 + nodes[i].y1) / 2;\n        if(distinctLayerPositions.indexOf(nodes[i].originalX) === -1) {\n            distinctLayerPositions.push(nodes[i].originalX);\n        }\n    }\n    distinctLayerPositions.sort(function(a, b) {return a - b;});\n    for(i = 0; i < nodes.length; i++) {\n        nodes[i].originalLayerIndex = distinctLayerPositions.indexOf(nodes[i].originalX);\n        nodes[i].originalLayer = nodes[i].originalLayerIndex / (distinctLayerPositions.length - 1);\n    }\n}\n\nfunction saveCurrentDragPosition(d) {\n    d.lastDraggedX = d.x0 + d.dx / 2;\n    d.lastDraggedY = d.y0 + d.dy / 2;\n}\n\nfunction sameLayer(d) {\n    return function(n) {return n.node.originalX === d.node.originalX;};\n}\n\nfunction switchToForceFormat(nodes) {\n    // force uses x, y as centers\n    for(var i = 0; i < nodes.length; i++) {\n        nodes[i].y = (nodes[i].y0 + nodes[i].y1) / 2;\n        nodes[i].x = (nodes[i].x0 + nodes[i].x1) / 2;\n    }\n}\n\nfunction switchToSankeyFormat(nodes) {\n    // sankey uses x0, x1, y0, y1\n    for(var i = 0; i < nodes.length; i++) {\n        nodes[i].y0 = nodes[i].y - nodes[i].dy / 2;\n        nodes[i].y1 = nodes[i].y0 + nodes[i].dy;\n\n        nodes[i].x0 = nodes[i].x - nodes[i].dx / 2;\n        nodes[i].x1 = nodes[i].x0 + nodes[i].dx;\n    }\n}\n\n// scene graph\nmodule.exports = function(gd, svg, calcData, layout, callbacks) {\n    // To prevent animation on first render\n    var firstRender = false;\n    Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'first-render', function() {\n        firstRender = true;\n    });\n\n    // To prevent animation on dragging\n    var dragcover = gd._fullLayout._dragCover;\n\n    var styledData = calcData\n            .filter(function(d) {return unwrap(d).trace.visible;})\n            .map(sankeyModel.bind(null, layout));\n\n    var sankey = svg.selectAll('.' + c.cn.sankey)\n        .data(styledData, keyFun);\n\n    sankey.exit()\n        .remove();\n\n    sankey.enter()\n        .append('g')\n        .classed(c.cn.sankey, true)\n        .style('box-sizing', 'content-box')\n        .style('position', 'absolute')\n        .style('left', 0)\n        .style('shape-rendering', 'geometricPrecision')\n        .style('pointer-events', 'auto')\n        .attr('transform', sankeyTransform);\n\n    sankey.each(function(d, i) {\n        gd._fullData[i]._sankey = d;\n        // Create dragbox if missing\n        var dragboxClassName = 'bgsankey-' + d.trace.uid + '-' + i;\n        Lib.ensureSingle(gd._fullLayout._draggers, 'rect', dragboxClassName);\n\n        gd._fullData[i]._bgRect = d3.select('.' + dragboxClassName);\n\n        // Style dragbox\n        gd._fullData[i]._bgRect\n          .style('pointer-events', 'all')\n          .attr('width', d.width)\n          .attr('height', d.height)\n          .attr('x', d.translateX)\n          .attr('y', d.translateY)\n          .classed('bgsankey', true)\n          .style({fill: 'transparent', 'stroke-width': 0});\n    });\n\n    sankey.transition()\n        .ease(c.ease).duration(c.duration)\n        .attr('transform', sankeyTransform);\n\n    var sankeyLinks = sankey.selectAll('.' + c.cn.sankeyLinks)\n        .data(repeat, keyFun);\n\n    sankeyLinks.enter()\n        .append('g')\n        .classed(c.cn.sankeyLinks, true)\n        .style('fill', 'none');\n\n    var sankeyLink = sankeyLinks.selectAll('.' + c.cn.sankeyLink)\n          .data(function(d) {\n              var links = d.graph.links;\n              return links\n                .filter(function(l) {return l.value;})\n                .map(linkModel.bind(null, d));\n          }, keyFun);\n\n    sankeyLink\n          .enter().append('path')\n          .classed(c.cn.sankeyLink, true)\n          .call(attachPointerEvents, sankey, callbacks.linkEvents);\n\n    sankeyLink\n        .style('stroke', function(d) {\n            return salientEnough(d) ? Color.tinyRGB(tinycolor(d.linkLineColor)) : d.tinyColorHue;\n        })\n        .style('stroke-opacity', function(d) {\n            return salientEnough(d) ? Color.opacity(d.linkLineColor) : d.tinyColorAlpha;\n        })\n        .style('fill', function(d) {\n            return d.tinyColorHue;\n        })\n        .style('fill-opacity', function(d) {\n            return d.tinyColorAlpha;\n        })\n        .style('stroke-width', function(d) {\n            return salientEnough(d) ? d.linkLineWidth : 1;\n        })\n        .attr('d', linkPath());\n\n    sankeyLink\n        .style('opacity', function() { return (gd._context.staticPlot || firstRender || dragcover) ? 1 : 0;})\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .style('opacity', 1);\n\n    sankeyLink.exit()\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .style('opacity', 0)\n        .remove();\n\n    var sankeyNodeSet = sankey.selectAll('.' + c.cn.sankeyNodeSet)\n        .data(repeat, keyFun);\n\n    sankeyNodeSet.enter()\n        .append('g')\n        .classed(c.cn.sankeyNodeSet, true);\n\n    sankeyNodeSet\n        .style('cursor', function(d) {\n            switch(d.arrangement) {\n                case 'fixed': return 'default';\n                case 'perpendicular': return 'ns-resize';\n                default: return 'move';\n            }\n        });\n\n    var sankeyNode = sankeyNodeSet.selectAll('.' + c.cn.sankeyNode)\n        .data(function(d) {\n            var nodes = d.graph.nodes;\n            persistOriginalPlace(nodes);\n            return nodes\n              .map(nodeModel.bind(null, d));\n        }, keyFun);\n\n    sankeyNode.enter()\n        .append('g')\n        .classed(c.cn.sankeyNode, true)\n        .call(updateNodePositions)\n        .style('opacity', function(n) { return ((gd._context.staticPlot || firstRender) && !n.partOfGroup) ? 1 : 0;});\n\n    sankeyNode\n        .call(attachPointerEvents, sankey, callbacks.nodeEvents)\n        .call(attachDragHandler, sankeyLink, callbacks, gd); // has to be here as it binds sankeyLink\n\n    sankeyNode\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .call(updateNodePositions)\n        .style('opacity', function(n) { return n.partOfGroup ? 0 : 1;});\n\n    sankeyNode.exit()\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .style('opacity', 0)\n        .remove();\n\n    var nodeRect = sankeyNode.selectAll('.' + c.cn.nodeRect)\n        .data(repeat);\n\n    nodeRect.enter()\n        .append('rect')\n        .classed(c.cn.nodeRect, true)\n        .call(sizeNode);\n\n    nodeRect\n        .style('stroke-width', function(d) {return d.nodeLineWidth;})\n        .style('stroke', function(d) {return Color.tinyRGB(tinycolor(d.nodeLineColor));})\n        .style('stroke-opacity', function(d) {return Color.opacity(d.nodeLineColor);})\n        .style('fill', function(d) {return d.tinyColorHue;})\n        .style('fill-opacity', function(d) {return d.tinyColorAlpha;});\n\n    nodeRect.transition()\n        .ease(c.ease).duration(c.duration)\n        .call(sizeNode);\n\n    var nodeCapture = sankeyNode.selectAll('.' + c.cn.nodeCapture)\n        .data(repeat);\n\n    nodeCapture.enter()\n        .append('rect')\n        .classed(c.cn.nodeCapture, true)\n        .style('fill-opacity', 0);\n\n    nodeCapture\n        .attr('x', function(d) {return d.zoneX;})\n        .attr('y', function(d) {return d.zoneY;})\n        .attr('width', function(d) {return d.zoneWidth;})\n        .attr('height', function(d) {return d.zoneHeight;});\n\n    var nodeCentered = sankeyNode.selectAll('.' + c.cn.nodeCentered)\n        .data(repeat);\n\n    nodeCentered.enter()\n        .append('g')\n        .classed(c.cn.nodeCentered, true)\n        .attr('transform', nodeCentering);\n\n    nodeCentered\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .attr('transform', nodeCentering);\n\n    var nodeLabelGuide = nodeCentered.selectAll('.' + c.cn.nodeLabelGuide)\n        .data(repeat);\n\n    nodeLabelGuide.enter()\n        .append('path')\n        .classed(c.cn.nodeLabelGuide, true)\n        .attr('id', function(d) {return d.uniqueNodeLabelPathId;})\n        .attr('d', textGuidePath)\n        .attr('transform', sankeyInverseTransform);\n\n    nodeLabelGuide\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .attr('d', textGuidePath)\n        .attr('transform', sankeyInverseTransform);\n\n    var nodeLabel = nodeCentered.selectAll('.' + c.cn.nodeLabel)\n        .data(repeat);\n\n    nodeLabel.enter()\n        .append('text')\n        .classed(c.cn.nodeLabel, true)\n        .attr('transform', textFlip)\n        .style('cursor', 'default')\n        .style('fill', 'black');\n\n    nodeLabel\n        .style('text-shadow', function(d) {\n            return d.horizontal ? '-1px 1px 1px #fff, 1px 1px 1px #fff, 1px -1px 1px #fff, -1px -1px 1px #fff' : 'none';\n        })\n        .each(function(d) {Drawing.font(nodeLabel, d.textFont);});\n\n    nodeLabel\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .attr('transform', textFlip);\n\n    var nodeLabelTextPath = nodeLabel.selectAll('.' + c.cn.nodeLabelTextPath)\n        .data(repeat);\n\n    nodeLabelTextPath.enter()\n        .append('textPath')\n        .classed(c.cn.nodeLabelTextPath, true)\n        .attr('alignment-baseline', 'middle')\n        .attr('xlink:href', function(d) {return '#' + d.uniqueNodeLabelPathId;})\n        .attr('startOffset', nodeTextOffset)\n        .style('fill', nodeTextColor);\n\n    nodeLabelTextPath\n        .text(function(d) {return d.horizontal || d.node.dy > 5 ? d.node.label : '';})\n        .attr('text-anchor', function(d) {return d.horizontal && d.left ? 'end' : 'start';});\n\n    nodeLabelTextPath\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .attr('startOffset', nodeTextOffset)\n        .style('fill', nodeTextColor);\n};\n"]},"metadata":{},"sourceType":"script"}