{"ast":null,"code":"/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar d3 = require('d3');\n\nvar render = require('./render');\n\nvar Fx = require('../../components/fx');\n\nvar Color = require('../../components/color');\n\nvar Lib = require('../../lib');\n\nvar cn = require('./constants').cn;\n\nvar _ = Lib._;\n\nfunction renderableValuePresent(d) {\n  return d !== '';\n}\n\nfunction ownTrace(selection, d) {\n  return selection.filter(function (s) {\n    return s.key === d.traceId;\n  });\n}\n\nfunction makeTranslucent(element, alpha) {\n  d3.select(element).select('path').style('fill-opacity', alpha);\n  d3.select(element).select('rect').style('fill-opacity', alpha);\n}\n\nfunction makeTextContrasty(element) {\n  d3.select(element).select('text.name').style('fill', 'black');\n}\n\nfunction relatedLinks(d) {\n  return function (l) {\n    return d.node.sourceLinks.indexOf(l.link) !== -1 || d.node.targetLinks.indexOf(l.link) !== -1;\n  };\n}\n\nfunction relatedNodes(l) {\n  return function (d) {\n    return d.node.sourceLinks.indexOf(l.link) !== -1 || d.node.targetLinks.indexOf(l.link) !== -1;\n  };\n}\n\nfunction nodeHoveredStyle(sankeyNode, d, sankey) {\n  if (d && sankey) {\n    ownTrace(sankey, d).selectAll('.' + cn.sankeyLink).filter(relatedLinks(d)).call(linkHoveredStyle.bind(0, d, sankey, false));\n  }\n}\n\nfunction nodeNonHoveredStyle(sankeyNode, d, sankey) {\n  if (d && sankey) {\n    ownTrace(sankey, d).selectAll('.' + cn.sankeyLink).filter(relatedLinks(d)).call(linkNonHoveredStyle.bind(0, d, sankey, false));\n  }\n}\n\nfunction linkHoveredStyle(d, sankey, visitNodes, sankeyLink) {\n  var label = sankeyLink.datum().link.label;\n  sankeyLink.style('fill-opacity', function (l) {\n    if (!l.link.concentrationscale) {\n      return 0.4;\n    }\n  });\n\n  if (label) {\n    ownTrace(sankey, d).selectAll('.' + cn.sankeyLink).filter(function (l) {\n      return l.link.label === label;\n    }).style('fill-opacity', function (l) {\n      if (!l.link.concentrationscale) {\n        return 0.4;\n      }\n    });\n  }\n\n  if (visitNodes) {\n    ownTrace(sankey, d).selectAll('.' + cn.sankeyNode).filter(relatedNodes(d)).call(nodeHoveredStyle);\n  }\n}\n\nfunction linkNonHoveredStyle(d, sankey, visitNodes, sankeyLink) {\n  var label = sankeyLink.datum().link.label;\n  sankeyLink.style('fill-opacity', function (d) {\n    return d.tinyColorAlpha;\n  });\n\n  if (label) {\n    ownTrace(sankey, d).selectAll('.' + cn.sankeyLink).filter(function (l) {\n      return l.link.label === label;\n    }).style('fill-opacity', function (d) {\n      return d.tinyColorAlpha;\n    });\n  }\n\n  if (visitNodes) {\n    ownTrace(sankey, d).selectAll(cn.sankeyNode).filter(relatedNodes(d)).call(nodeNonHoveredStyle);\n  }\n} // does not support array values for now\n\n\nfunction castHoverOption(trace, attr) {\n  var labelOpts = trace.hoverlabel || {};\n  var val = Lib.nestedProperty(labelOpts, attr).get();\n  return Array.isArray(val) ? false : val;\n}\n\nmodule.exports = function plot(gd, calcData) {\n  var fullLayout = gd._fullLayout;\n  var svg = fullLayout._paper;\n  var size = fullLayout._size; // stash initial view\n\n  for (var i = 0; i < gd._fullData.length; i++) {\n    if (!gd._fullData[i].visible) continue;\n    if (gd._fullData[i].type !== cn.sankey) continue;\n\n    if (!gd._fullData[i]._viewInitial) {\n      var node = gd._fullData[i].node;\n      gd._fullData[i]._viewInitial = {\n        node: {\n          groups: node.groups.slice(),\n          x: node.x.slice(),\n          y: node.y.slice()\n        }\n      };\n    }\n  }\n\n  var linkSelect = function (element, d) {\n    var evt = d.link;\n    evt.originalEvent = d3.event;\n    gd._hoverdata = [evt];\n    Fx.click(gd, {\n      target: true\n    });\n  };\n\n  var linkHover = function (element, d, sankey) {\n    if (gd._fullLayout.hovermode === false) return;\n    d3.select(element).call(linkHoveredStyle.bind(0, d, sankey, true));\n\n    if (d.link.trace.link.hoverinfo !== 'skip') {\n      d.link.fullData = d.link.trace;\n      gd.emit('plotly_hover', {\n        event: d3.event,\n        points: [d.link]\n      });\n    }\n  };\n\n  var sourceLabel = _(gd, 'source:') + ' ';\n  var targetLabel = _(gd, 'target:') + ' ';\n  var concentrationLabel = _(gd, 'concentration:') + ' ';\n  var incomingLabel = _(gd, 'incoming flow count:') + ' ';\n  var outgoingLabel = _(gd, 'outgoing flow count:') + ' ';\n\n  var linkHoverFollow = function (element, d) {\n    if (gd._fullLayout.hovermode === false) return;\n    var obj = d.link.trace.link;\n    if (obj.hoverinfo === 'none' || obj.hoverinfo === 'skip') return;\n    var hoverItems = [];\n\n    function hoverCenterPosition(link) {\n      var hoverCenterX, hoverCenterY;\n\n      if (link.circular) {\n        hoverCenterX = (link.circularPathData.leftInnerExtent + link.circularPathData.rightInnerExtent) / 2;\n        hoverCenterY = link.circularPathData.verticalFullExtent;\n      } else {\n        hoverCenterX = (link.source.x1 + link.target.x0) / 2;\n        hoverCenterY = (link.y0 + link.y1) / 2;\n      }\n\n      var center = [hoverCenterX, hoverCenterY];\n      if (link.trace.orientation === 'v') center.reverse();\n      center[0] += d.parent.translateX;\n      center[1] += d.parent.translateY;\n      return center;\n    } // For each related links, create a hoverItem\n\n\n    var anchorIndex = 0;\n\n    for (var i = 0; i < d.flow.links.length; i++) {\n      var link = d.flow.links[i];\n      if (gd._fullLayout.hovermode === 'closest' && d.link.pointNumber !== link.pointNumber) continue;\n      if (d.link.pointNumber === link.pointNumber) anchorIndex = i;\n      link.fullData = link.trace;\n      obj = d.link.trace.link;\n      var hoverCenter = hoverCenterPosition(link);\n      var hovertemplateLabels = {\n        valueLabel: d3.format(d.valueFormat)(link.value) + d.valueSuffix\n      };\n      hoverItems.push({\n        x: hoverCenter[0],\n        y: hoverCenter[1],\n        name: hovertemplateLabels.valueLabel,\n        text: [link.label || '', sourceLabel + link.source.label, targetLabel + link.target.label, link.concentrationscale ? concentrationLabel + d3.format('%0.2f')(link.flow.labelConcentration) : ''].filter(renderableValuePresent).join('<br>'),\n        color: castHoverOption(obj, 'bgcolor') || Color.addOpacity(link.color, 1),\n        borderColor: castHoverOption(obj, 'bordercolor'),\n        fontFamily: castHoverOption(obj, 'font.family'),\n        fontSize: castHoverOption(obj, 'font.size'),\n        fontColor: castHoverOption(obj, 'font.color'),\n        nameLength: castHoverOption(obj, 'namelength'),\n        textAlign: castHoverOption(obj, 'align'),\n        idealAlign: d3.event.x < hoverCenter[0] ? 'right' : 'left',\n        hovertemplate: obj.hovertemplate,\n        hovertemplateLabels: hovertemplateLabels,\n        eventData: [link]\n      });\n    }\n\n    var tooltips = Fx.loneHover(hoverItems, {\n      container: fullLayout._hoverlayer.node(),\n      outerContainer: fullLayout._paper.node(),\n      gd: gd,\n      anchorIndex: anchorIndex\n    });\n    tooltips.each(function () {\n      var tooltip = this;\n\n      if (!d.link.concentrationscale) {\n        makeTranslucent(tooltip, 0.65);\n      }\n\n      makeTextContrasty(tooltip);\n    });\n  };\n\n  var linkUnhover = function (element, d, sankey) {\n    if (gd._fullLayout.hovermode === false) return;\n    d3.select(element).call(linkNonHoveredStyle.bind(0, d, sankey, true));\n\n    if (d.link.trace.link.hoverinfo !== 'skip') {\n      d.link.fullData = d.link.trace;\n      gd.emit('plotly_unhover', {\n        event: d3.event,\n        points: [d.link]\n      });\n    }\n\n    Fx.loneUnhover(fullLayout._hoverlayer.node());\n  };\n\n  var nodeSelect = function (element, d, sankey) {\n    var evt = d.node;\n    evt.originalEvent = d3.event;\n    gd._hoverdata = [evt];\n    d3.select(element).call(nodeNonHoveredStyle, d, sankey);\n    Fx.click(gd, {\n      target: true\n    });\n  };\n\n  var nodeHover = function (element, d, sankey) {\n    if (gd._fullLayout.hovermode === false) return;\n    d3.select(element).call(nodeHoveredStyle, d, sankey);\n\n    if (d.node.trace.node.hoverinfo !== 'skip') {\n      d.node.fullData = d.node.trace;\n      gd.emit('plotly_hover', {\n        event: d3.event,\n        points: [d.node]\n      });\n    }\n  };\n\n  var nodeHoverFollow = function (element, d) {\n    if (gd._fullLayout.hovermode === false) return;\n    var obj = d.node.trace.node;\n    if (obj.hoverinfo === 'none' || obj.hoverinfo === 'skip') return;\n    var nodeRect = d3.select(element).select('.' + cn.nodeRect);\n\n    var rootBBox = gd._fullLayout._paperdiv.node().getBoundingClientRect();\n\n    var boundingBox = nodeRect.node().getBoundingClientRect();\n    var hoverCenterX0 = boundingBox.left - 2 - rootBBox.left;\n    var hoverCenterX1 = boundingBox.right + 2 - rootBBox.left;\n    var hoverCenterY = boundingBox.top + boundingBox.height / 4 - rootBBox.top;\n    var hovertemplateLabels = {\n      valueLabel: d3.format(d.valueFormat)(d.node.value) + d.valueSuffix\n    };\n    d.node.fullData = d.node.trace;\n\n    gd._fullLayout._calcInverseTransform(gd);\n\n    var scaleX = gd._fullLayout._invScaleX;\n    var scaleY = gd._fullLayout._invScaleY;\n    var tooltip = Fx.loneHover({\n      x0: scaleX * hoverCenterX0,\n      x1: scaleX * hoverCenterX1,\n      y: scaleY * hoverCenterY,\n      name: d3.format(d.valueFormat)(d.node.value) + d.valueSuffix,\n      text: [d.node.label, incomingLabel + d.node.targetLinks.length, outgoingLabel + d.node.sourceLinks.length].filter(renderableValuePresent).join('<br>'),\n      color: castHoverOption(obj, 'bgcolor') || d.tinyColorHue,\n      borderColor: castHoverOption(obj, 'bordercolor'),\n      fontFamily: castHoverOption(obj, 'font.family'),\n      fontSize: castHoverOption(obj, 'font.size'),\n      fontColor: castHoverOption(obj, 'font.color'),\n      nameLength: castHoverOption(obj, 'namelength'),\n      textAlign: castHoverOption(obj, 'align'),\n      idealAlign: 'left',\n      hovertemplate: obj.hovertemplate,\n      hovertemplateLabels: hovertemplateLabels,\n      eventData: [d.node]\n    }, {\n      container: fullLayout._hoverlayer.node(),\n      outerContainer: fullLayout._paper.node(),\n      gd: gd\n    });\n    makeTranslucent(tooltip, 0.85);\n    makeTextContrasty(tooltip);\n  };\n\n  var nodeUnhover = function (element, d, sankey) {\n    if (gd._fullLayout.hovermode === false) return;\n    d3.select(element).call(nodeNonHoveredStyle, d, sankey);\n\n    if (d.node.trace.node.hoverinfo !== 'skip') {\n      d.node.fullData = d.node.trace;\n      gd.emit('plotly_unhover', {\n        event: d3.event,\n        points: [d.node]\n      });\n    }\n\n    Fx.loneUnhover(fullLayout._hoverlayer.node());\n  };\n\n  render(gd, svg, calcData, {\n    width: size.w,\n    height: size.h,\n    margin: {\n      t: size.t,\n      r: size.r,\n      b: size.b,\n      l: size.l\n    }\n  }, {\n    linkEvents: {\n      hover: linkHover,\n      follow: linkHoverFollow,\n      unhover: linkUnhover,\n      select: linkSelect\n    },\n    nodeEvents: {\n      hover: nodeHover,\n      follow: nodeHoverFollow,\n      unhover: nodeUnhover,\n      select: nodeSelect\n    }\n  });\n};","map":{"version":3,"sources":["/Users/caseyrudick/Documents/landsharkrefactored-copy/client/node_modules/plotly.js/src/traces/sankey/plot.js"],"names":["d3","require","render","Fx","Color","Lib","cn","_","renderableValuePresent","d","ownTrace","selection","filter","s","key","traceId","makeTranslucent","element","alpha","select","style","makeTextContrasty","relatedLinks","l","node","sourceLinks","indexOf","link","targetLinks","relatedNodes","nodeHoveredStyle","sankeyNode","sankey","selectAll","sankeyLink","call","linkHoveredStyle","bind","nodeNonHoveredStyle","linkNonHoveredStyle","visitNodes","label","datum","concentrationscale","tinyColorAlpha","castHoverOption","trace","attr","labelOpts","hoverlabel","val","nestedProperty","get","Array","isArray","module","exports","plot","gd","calcData","fullLayout","_fullLayout","svg","_paper","size","_size","i","_fullData","length","visible","type","_viewInitial","groups","slice","x","y","linkSelect","evt","originalEvent","event","_hoverdata","click","target","linkHover","hovermode","hoverinfo","fullData","emit","points","sourceLabel","targetLabel","concentrationLabel","incomingLabel","outgoingLabel","linkHoverFollow","obj","hoverItems","hoverCenterPosition","hoverCenterX","hoverCenterY","circular","circularPathData","leftInnerExtent","rightInnerExtent","verticalFullExtent","source","x1","x0","y0","y1","center","orientation","reverse","parent","translateX","translateY","anchorIndex","flow","links","pointNumber","hoverCenter","hovertemplateLabels","valueLabel","format","valueFormat","value","valueSuffix","push","name","text","labelConcentration","join","color","addOpacity","borderColor","fontFamily","fontSize","fontColor","nameLength","textAlign","idealAlign","hovertemplate","eventData","tooltips","loneHover","container","_hoverlayer","outerContainer","each","tooltip","linkUnhover","loneUnhover","nodeSelect","nodeHover","nodeHoverFollow","nodeRect","rootBBox","_paperdiv","getBoundingClientRect","boundingBox","hoverCenterX0","left","hoverCenterX1","right","top","height","_calcInverseTransform","scaleX","_invScaleX","scaleY","_invScaleY","tinyColorHue","nodeUnhover","width","w","h","margin","t","r","b","linkEvents","hover","follow","unhover","nodeEvents"],"mappings":"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","sourcesContent":["/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n\n'use strict';\n\nvar d3 = require('d3');\nvar render = require('./render');\nvar Fx = require('../../components/fx');\nvar Color = require('../../components/color');\nvar Lib = require('../../lib');\nvar cn = require('./constants').cn;\n\nvar _ = Lib._;\n\nfunction renderableValuePresent(d) {return d !== '';}\n\nfunction ownTrace(selection, d) {\n    return selection.filter(function(s) {return s.key === d.traceId;});\n}\n\nfunction makeTranslucent(element, alpha) {\n    d3.select(element)\n        .select('path')\n        .style('fill-opacity', alpha);\n    d3.select(element)\n        .select('rect')\n        .style('fill-opacity', alpha);\n}\n\nfunction makeTextContrasty(element) {\n    d3.select(element)\n        .select('text.name')\n        .style('fill', 'black');\n}\n\nfunction relatedLinks(d) {\n    return function(l) {\n        return d.node.sourceLinks.indexOf(l.link) !== -1 || d.node.targetLinks.indexOf(l.link) !== -1;\n    };\n}\n\nfunction relatedNodes(l) {\n    return function(d) {\n        return d.node.sourceLinks.indexOf(l.link) !== -1 || d.node.targetLinks.indexOf(l.link) !== -1;\n    };\n}\n\nfunction nodeHoveredStyle(sankeyNode, d, sankey) {\n    if(d && sankey) {\n        ownTrace(sankey, d)\n            .selectAll('.' + cn.sankeyLink)\n            .filter(relatedLinks(d))\n            .call(linkHoveredStyle.bind(0, d, sankey, false));\n    }\n}\n\nfunction nodeNonHoveredStyle(sankeyNode, d, sankey) {\n    if(d && sankey) {\n        ownTrace(sankey, d)\n            .selectAll('.' + cn.sankeyLink)\n            .filter(relatedLinks(d))\n            .call(linkNonHoveredStyle.bind(0, d, sankey, false));\n    }\n}\n\nfunction linkHoveredStyle(d, sankey, visitNodes, sankeyLink) {\n    var label = sankeyLink.datum().link.label;\n\n    sankeyLink.style('fill-opacity', function(l) {\n        if(!l.link.concentrationscale) {\n            return 0.4;\n        }\n    });\n\n    if(label) {\n        ownTrace(sankey, d)\n            .selectAll('.' + cn.sankeyLink)\n            .filter(function(l) {return l.link.label === label;})\n            .style('fill-opacity', function(l) {\n                if(!l.link.concentrationscale) {\n                    return 0.4;\n                }\n            });\n    }\n\n    if(visitNodes) {\n        ownTrace(sankey, d)\n            .selectAll('.' + cn.sankeyNode)\n            .filter(relatedNodes(d))\n            .call(nodeHoveredStyle);\n    }\n}\n\nfunction linkNonHoveredStyle(d, sankey, visitNodes, sankeyLink) {\n    var label = sankeyLink.datum().link.label;\n\n    sankeyLink.style('fill-opacity', function(d) {return d.tinyColorAlpha;});\n    if(label) {\n        ownTrace(sankey, d)\n            .selectAll('.' + cn.sankeyLink)\n            .filter(function(l) {return l.link.label === label;})\n            .style('fill-opacity', function(d) {return d.tinyColorAlpha;});\n    }\n\n    if(visitNodes) {\n        ownTrace(sankey, d)\n            .selectAll(cn.sankeyNode)\n            .filter(relatedNodes(d))\n            .call(nodeNonHoveredStyle);\n    }\n}\n\n// does not support array values for now\nfunction castHoverOption(trace, attr) {\n    var labelOpts = trace.hoverlabel || {};\n    var val = Lib.nestedProperty(labelOpts, attr).get();\n    return Array.isArray(val) ? false : val;\n}\n\nmodule.exports = function plot(gd, calcData) {\n    var fullLayout = gd._fullLayout;\n    var svg = fullLayout._paper;\n    var size = fullLayout._size;\n\n    // stash initial view\n    for(var i = 0; i < gd._fullData.length; i++) {\n        if(!gd._fullData[i].visible) continue;\n        if(gd._fullData[i].type !== cn.sankey) continue;\n        if(!gd._fullData[i]._viewInitial) {\n            var node = gd._fullData[i].node;\n            gd._fullData[i]._viewInitial = {\n                node: {\n                    groups: node.groups.slice(),\n                    x: node.x.slice(),\n                    y: node.y.slice()\n                }\n            };\n        }\n    }\n\n    var linkSelect = function(element, d) {\n        var evt = d.link;\n        evt.originalEvent = d3.event;\n        gd._hoverdata = [evt];\n        Fx.click(gd, { target: true });\n    };\n\n    var linkHover = function(element, d, sankey) {\n        if(gd._fullLayout.hovermode === false) return;\n        d3.select(element).call(linkHoveredStyle.bind(0, d, sankey, true));\n        if(d.link.trace.link.hoverinfo !== 'skip') {\n            d.link.fullData = d.link.trace;\n            gd.emit('plotly_hover', {\n                event: d3.event,\n                points: [d.link]\n            });\n        }\n    };\n\n    var sourceLabel = _(gd, 'source:') + ' ';\n    var targetLabel = _(gd, 'target:') + ' ';\n    var concentrationLabel = _(gd, 'concentration:') + ' ';\n    var incomingLabel = _(gd, 'incoming flow count:') + ' ';\n    var outgoingLabel = _(gd, 'outgoing flow count:') + ' ';\n\n    var linkHoverFollow = function(element, d) {\n        if(gd._fullLayout.hovermode === false) return;\n        var obj = d.link.trace.link;\n        if(obj.hoverinfo === 'none' || obj.hoverinfo === 'skip') return;\n\n        var hoverItems = [];\n\n        function hoverCenterPosition(link) {\n            var hoverCenterX, hoverCenterY;\n            if(link.circular) {\n                hoverCenterX = (link.circularPathData.leftInnerExtent + link.circularPathData.rightInnerExtent) / 2;\n                hoverCenterY = link.circularPathData.verticalFullExtent;\n            } else {\n                hoverCenterX = (link.source.x1 + link.target.x0) / 2;\n                hoverCenterY = (link.y0 + link.y1) / 2;\n            }\n            var center = [hoverCenterX, hoverCenterY];\n            if(link.trace.orientation === 'v') center.reverse();\n            center[0] += d.parent.translateX;\n            center[1] += d.parent.translateY;\n            return center;\n        }\n\n        // For each related links, create a hoverItem\n        var anchorIndex = 0;\n        for(var i = 0; i < d.flow.links.length; i++) {\n            var link = d.flow.links[i];\n            if(gd._fullLayout.hovermode === 'closest' && d.link.pointNumber !== link.pointNumber) continue;\n            if(d.link.pointNumber === link.pointNumber) anchorIndex = i;\n            link.fullData = link.trace;\n            obj = d.link.trace.link;\n            var hoverCenter = hoverCenterPosition(link);\n            var hovertemplateLabels = {valueLabel: d3.format(d.valueFormat)(link.value) + d.valueSuffix};\n\n            hoverItems.push({\n                x: hoverCenter[0],\n                y: hoverCenter[1],\n                name: hovertemplateLabels.valueLabel,\n                text: [\n                    link.label || '',\n                    sourceLabel + link.source.label,\n                    targetLabel + link.target.label,\n                    link.concentrationscale ? concentrationLabel + d3.format('%0.2f')(link.flow.labelConcentration) : ''\n                ].filter(renderableValuePresent).join('<br>'),\n                color: castHoverOption(obj, 'bgcolor') || Color.addOpacity(link.color, 1),\n                borderColor: castHoverOption(obj, 'bordercolor'),\n                fontFamily: castHoverOption(obj, 'font.family'),\n                fontSize: castHoverOption(obj, 'font.size'),\n                fontColor: castHoverOption(obj, 'font.color'),\n                nameLength: castHoverOption(obj, 'namelength'),\n                textAlign: castHoverOption(obj, 'align'),\n                idealAlign: d3.event.x < hoverCenter[0] ? 'right' : 'left',\n\n                hovertemplate: obj.hovertemplate,\n                hovertemplateLabels: hovertemplateLabels,\n                eventData: [link]\n            });\n        }\n\n        var tooltips = Fx.loneHover(hoverItems, {\n            container: fullLayout._hoverlayer.node(),\n            outerContainer: fullLayout._paper.node(),\n            gd: gd,\n            anchorIndex: anchorIndex\n        });\n\n        tooltips.each(function() {\n            var tooltip = this;\n            if(!d.link.concentrationscale) {\n                makeTranslucent(tooltip, 0.65);\n            }\n            makeTextContrasty(tooltip);\n        });\n    };\n\n    var linkUnhover = function(element, d, sankey) {\n        if(gd._fullLayout.hovermode === false) return;\n        d3.select(element).call(linkNonHoveredStyle.bind(0, d, sankey, true));\n        if(d.link.trace.link.hoverinfo !== 'skip') {\n            d.link.fullData = d.link.trace;\n            gd.emit('plotly_unhover', {\n                event: d3.event,\n                points: [d.link]\n            });\n        }\n\n        Fx.loneUnhover(fullLayout._hoverlayer.node());\n    };\n\n    var nodeSelect = function(element, d, sankey) {\n        var evt = d.node;\n        evt.originalEvent = d3.event;\n        gd._hoverdata = [evt];\n        d3.select(element).call(nodeNonHoveredStyle, d, sankey);\n        Fx.click(gd, { target: true });\n    };\n\n    var nodeHover = function(element, d, sankey) {\n        if(gd._fullLayout.hovermode === false) return;\n        d3.select(element).call(nodeHoveredStyle, d, sankey);\n        if(d.node.trace.node.hoverinfo !== 'skip') {\n            d.node.fullData = d.node.trace;\n            gd.emit('plotly_hover', {\n                event: d3.event,\n                points: [d.node]\n            });\n        }\n    };\n\n    var nodeHoverFollow = function(element, d) {\n        if(gd._fullLayout.hovermode === false) return;\n\n        var obj = d.node.trace.node;\n        if(obj.hoverinfo === 'none' || obj.hoverinfo === 'skip') return;\n        var nodeRect = d3.select(element).select('.' + cn.nodeRect);\n        var rootBBox = gd._fullLayout._paperdiv.node().getBoundingClientRect();\n        var boundingBox = nodeRect.node().getBoundingClientRect();\n        var hoverCenterX0 = boundingBox.left - 2 - rootBBox.left;\n        var hoverCenterX1 = boundingBox.right + 2 - rootBBox.left;\n        var hoverCenterY = boundingBox.top + boundingBox.height / 4 - rootBBox.top;\n\n        var hovertemplateLabels = {valueLabel: d3.format(d.valueFormat)(d.node.value) + d.valueSuffix};\n        d.node.fullData = d.node.trace;\n\n        gd._fullLayout._calcInverseTransform(gd);\n        var scaleX = gd._fullLayout._invScaleX;\n        var scaleY = gd._fullLayout._invScaleY;\n\n        var tooltip = Fx.loneHover({\n            x0: scaleX * hoverCenterX0,\n            x1: scaleX * hoverCenterX1,\n            y: scaleY * hoverCenterY,\n            name: d3.format(d.valueFormat)(d.node.value) + d.valueSuffix,\n            text: [\n                d.node.label,\n                incomingLabel + d.node.targetLinks.length,\n                outgoingLabel + d.node.sourceLinks.length\n            ].filter(renderableValuePresent).join('<br>'),\n            color: castHoverOption(obj, 'bgcolor') || d.tinyColorHue,\n            borderColor: castHoverOption(obj, 'bordercolor'),\n            fontFamily: castHoverOption(obj, 'font.family'),\n            fontSize: castHoverOption(obj, 'font.size'),\n            fontColor: castHoverOption(obj, 'font.color'),\n            nameLength: castHoverOption(obj, 'namelength'),\n            textAlign: castHoverOption(obj, 'align'),\n            idealAlign: 'left',\n\n            hovertemplate: obj.hovertemplate,\n            hovertemplateLabels: hovertemplateLabels,\n            eventData: [d.node]\n        }, {\n            container: fullLayout._hoverlayer.node(),\n            outerContainer: fullLayout._paper.node(),\n            gd: gd\n        });\n\n        makeTranslucent(tooltip, 0.85);\n        makeTextContrasty(tooltip);\n    };\n\n    var nodeUnhover = function(element, d, sankey) {\n        if(gd._fullLayout.hovermode === false) return;\n        d3.select(element).call(nodeNonHoveredStyle, d, sankey);\n        if(d.node.trace.node.hoverinfo !== 'skip') {\n            d.node.fullData = d.node.trace;\n            gd.emit('plotly_unhover', {\n                event: d3.event,\n                points: [d.node]\n            });\n        }\n\n        Fx.loneUnhover(fullLayout._hoverlayer.node());\n    };\n\n    render(\n        gd,\n        svg,\n        calcData,\n        {\n            width: size.w,\n            height: size.h,\n            margin: {\n                t: size.t,\n                r: size.r,\n                b: size.b,\n                l: size.l\n            }\n        },\n        {\n            linkEvents: {\n                hover: linkHover,\n                follow: linkHoverFollow,\n                unhover: linkUnhover,\n                select: linkSelect\n            },\n            nodeEvents: {\n                hover: nodeHover,\n                follow: nodeHoverFollow,\n                unhover: nodeUnhover,\n                select: nodeSelect\n            }\n        }\n    );\n};\n"]},"metadata":{},"sourceType":"script"}